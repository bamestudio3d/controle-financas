<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=5, user-scalable=no" />
  <title>Finanças Pro V3.3</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#8A05BE">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <link rel="stylesheet" href="estilo-nubank.css">

  <style>
    /* Estilos base para garantir responsividade */
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    @media (max-width: 640px) {
      input, select, textarea { font-size: 16px !important; }
      .touch-target { min-height: 44px; }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // --- COMPONENTES DE ÍCONES ---
    const Plus = () => <span className="material-icons-round">add</span>;
    const Trash = () => <span className="material-icons-round">delete</span>;
    const Edit = () => <span className="material-icons-round">edit</span>;

    // --- COMPONENTE PRINCIPAL APP ---
    function App() {
      // ESTADOS (Recuperando do LocalStorage)
      const [payments, setPayments] = useState(() => JSON.parse(localStorage.getItem('financas_payments') || '[]'));
      const [creditCards, setCreditCards] = useState(() => JSON.parse(localStorage.getItem('financas_cards') || '[]'));
      const [creditCardPurchases, setCreditCardPurchases] = useState(() => JSON.parse(localStorage.getItem('financas_card_purchases') || '[]'));
      const [entries, setEntries] = useState(() => JSON.parse(localStorage.getItem('financas_entries') || '[]'));
      const [reservations, setReservations] = useState(() => JSON.parse(localStorage.getItem('financas_reservations') || '[]'));
      
      const [darkMode, setDarkMode] = useState(true);
      const [selectedMonthKey, setSelectedMonthKey] = useState(() => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      });

      // UI States
      const [showAddPayment, setShowAddPayment] = useState(false);
      const [notification, setNotification] = useState({ show: false, text: '', type: 'success' });

      // PERSISTÊNCIA AUTOMÁTICA
      useEffect(() => {
        localStorage.setItem('financas_payments', JSON.stringify(payments));
        localStorage.setItem('financas_cards', JSON.stringify(creditCards));
        localStorage.setItem('financas_card_purchases', JSON.stringify(creditCardPurchases));
        localStorage.setItem('financas_entries', JSON.stringify(entries));
        localStorage.setItem('financas_reservations', JSON.stringify(reservations));
      }, [payments, creditCards, creditCardPurchases, entries, reservations]);

      // FUNÇÕES DE UTILIDADE
      const currencyFormat = (val) => Number(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      
      const notify = (text, type = 'success') => {
        setNotification({ show: true, text, type });
        setTimeout(() => setNotification({ show: false, text: '', type: 'success' }), 3000);
      };

      // CÁLCULOS DE TOTAIS
      const totals = useMemo(() => {
        const monthPayments = payments.filter(p => p.dueDateIso && p.dueDateIso.startsWith(selectedMonthKey));
        const totalPaid = monthPayments.filter(p => p.paid).reduce((acc, p) => acc + p.amount, 0);
        const totalPending = monthPayments.filter(p => !p.paid).reduce((acc, p) => acc + p.amount, 0);
        return { totalPaid, totalPending, total: totalPaid + totalPending };
      }, [payments, selectedMonthKey]);

      return (
        <div className={darkMode ? "dark" : ""}>
          <div className="min-h-screen bg-gray-50 dark:bg-[#0b0f1a] text-gray-900 dark:text-gray-100 pb-24">
            
            {/* Header */}
            <header className="p-4 flex justify-between items-center sticky top-0 z-40 bg-white/80 dark:bg-[#0b0f1a]/80 backdrop-blur-md border-b dark:border-gray-800">
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">Minhas Finanças</h1>
                <p className="text-xs text-gray-500">{selectedMonthKey}</p>
              </div>
              <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full bg-gray-200 dark:bg-gray-800">
                <span className="material-icons-round text-sm">{darkMode ? 'light_mode' : 'dark_mode'}</span>
              </button>
            </header>

            {/* Conteúdo Principal */}
            <main className="p-4 max-w-4xl mx-auto space-y-6">
              
              {/* Card de Saldo Geral */}
              <div className="bg-gradient-to-br from-[#8A05BE] to-[#E0209B] p-6 rounded-[24px] shadow-lg text-white">
                <p className="text-white/80 text-sm mb-1">Total Previsto no Mês</p>
                <h2 className="text-3xl font-bold mb-4">{currencyFormat(totals.total)}</h2>
                <div className="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
                  <div>
                    <p className="text-xs opacity-80 uppercase">Já Pago</p>
                    <p className="font-semibold">{currencyFormat(totals.totalPaid)}</p>
                  </div>
                  <div>
                    <p className="text-xs opacity-80 uppercase">Pendente</p>
                    <p className="font-semibold">{currencyFormat(totals.totalPending)}</p>
                  </div>
                </div>
              </div>

              {/* Botões de Ação */}
              <div className="grid grid-cols-2 gap-3">
                <button onClick={() => setShowAddPayment(true)} className="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-2xl transition-all">
                  <Plus /> <span>Adicionar Gasto</span>
                </button>
                <button className="flex items-center justify-center gap-2 bg-gray-200 dark:bg-gray-800 p-4 rounded-2xl">
                  <span className="material-icons-round">credit_card</span> <span>Cartões</span>
                </button>
              </div>

              {/* Lista de Gastos */}
              <section>
                <h3 className="font-bold mb-4 flex items-center gap-2">
                   <span className="material-icons-round text-purple-500">receipt_long</span> Gastos do Mês
                </h3>
                <div className="space-y-3">
                  {payments.filter(p => p.dueDateIso?.startsWith(selectedMonthKey)).length === 0 ? (
                    <p className="text-center py-10 text-gray-500 italic">Nenhum gasto registrado para este mês.</p>
                  ) : (
                    payments.filter(p => p.dueDateIso?.startsWith(selectedMonthKey)).map(p => (
                      <div key={p.id} className="bg-white dark:bg-gray-800 p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-100 dark:border-gray-700">
                        <div className="flex items-center gap-3">
                          <div className={`p-2 rounded-xl ${p.paid ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}`}>
                            <span className="material-icons-round">{p.paid ? 'check_circle' : 'pending'}</span>
                          </div>
                          <div>
                            <p className="font-semibold text-sm">{p.title}</p>
                            <p className="text-xs text-gray-500">{p.category || 'Geral'}</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className={`font-bold ${p.paid ? 'text-green-500' : 'text-gray-900 dark:text-white'}`}>{currencyFormat(p.amount)}</p>
                          <button onClick={() => setPayments(payments.filter(x => x.id !== p.id))} className="text-xs text-red-400 mt-1">Excluir</button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </section>

            </main>

            {/* Barra de Navegação PWA */}
            <nav className="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-t dark:border-gray-800 px-6 py-3 flex justify-between items-center z-50">
               <button className="flex flex-col items-center gap-1 text-purple-600">
                 <span className="material-icons-round">home</span>
                 <span className="text-[10px]">Início</span>
               </button>
               <button className="flex flex-col items-center gap-1 text-gray-500">
                 <span className="material-icons-round">bar_chart</span>
                 <span className="text-[10px]">Relatórios</span>
               </button>
               <button onClick={() => setShowAddPayment(true)} className="bg-purple-600 text-white w-12 h-12 rounded-full -mt-10 shadow-lg flex items-center justify-center border-4 border-white dark:border-gray-900">
                 <Plus />
               </button>
               <button className="flex flex-col items-center gap-1 text-gray-500">
                 <span className="material-icons-round">account_balance_wallet</span>
                 <span className="text-[10px]">Reservas</span>
               </button>
               <button className="flex flex-col items-center gap-1 text-gray-500">
                 <span className="material-icons-round">settings</span>
                 <span className="text-[10px]">Ajustes</span>
               </button>
            </nav>

            {/* Modal de Cadastro Simples (Exemplo) */}
            {showAddPayment && (
              <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-all fade-in">
                <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl">
                  <h2 className="text-xl font-bold mb-6">Novo Gasto</h2>
                  <div className="space-y-4">
                    <input type="text" id="p_title" placeholder="Nome do gasto" className="w-full p-4 rounded-2xl bg-gray-100 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-purple-500" />
                    <input type="number" id="p_amount" placeholder="Valor R$" className="w-full p-4 rounded-2xl bg-gray-100 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-purple-500" />
                    <div className="flex gap-2">
                      <button onClick={() => setShowAddPayment(false)} className="flex-1 p-4 rounded-2xl bg-gray-200 dark:bg-gray-700 font-bold">Cancelar</button>
                      <button onClick={() => {
                        const t = document.getElementById('p_title').value;
                        const a = parseFloat(document.getElementById('p_amount').value);
                        if(t && a) {
                          setPayments([...payments, { id: Date.now(), title: t, amount: a, dueDateIso: selectedMonthKey + '-10', paid: false }]);
                          setShowAddPayment(false);
                          notify('Gasto adicionado!');
                        }
                      }} className="flex-1 p-4 rounded-2xl bg-purple-600 text-white font-bold">Salvar</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Notificação */}
            {notification.show && (
              <div className="fixed top-6 right-6 left-6 sm:left-auto bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-4 rounded-2xl shadow-2xl z-[200] flex items-center gap-3 fade-in border border-gray-700">
                <span className="material-icons-round text-green-500">check_circle</span>
                <span className="font-semibold">{notification.text}</span>
              </div>
            )}

          </div>
        </div>
      );
    }

    // RENDER
    ReactDOM.render(<App />, document.getElementById('root'));

    // SERVICE WORKER REGISTRATION
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(err => console.log("SW error", err));
      });
    }
  </script>
</body>
</html>
