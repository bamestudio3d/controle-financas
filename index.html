<head><link rel="stylesheet" href="estilo-nubank.css"></head>
<!-- PWA Meta Tags -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Finan√ßas">
<link rel="apple-touch-icon" href="./icon-192.png">
<link rel="icon" type="image/png" href="./icon-192.png">

<!-- Service Worker Registration -->
<script>
  // Registrar Service Worker para PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(error => {
          console.log('Falha ao registrar Service Worker:', error);
        });
    });
  }
</script>


<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Finan√ßas ‚Ä¢ Controle Financeiro Pessoal</title>
  
  <!-- React e depend√™ncias -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilos customizados -->
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      background: #0C0C0C;
      color: white;
      margin: 0;
      padding: 0;
    }
    
    .nubank-card {
      background: linear-gradient(135deg, #8A05BE, #E0209B);
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(138, 5, 190, 0.3);
    }
    
    .card-modern {
      background: #1A1A1A;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #8A05BE, #E0209B);
      color: white;
      border: none;
      border-radius: 100px;
      font-weight: 600;
      padding: 12px 24px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 100px;
      font-weight: 500;
      padding: 12px 24px;
      cursor: pointer;
    }
    
    .input-modern {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      padding: 12px 16px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .input-modern:focus {
      outline: none;
      border-color: #8A05BE;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Anima√ß√µes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .slide-in-right {
      animation: slideInRight 0.3s ease-out;
    }
    
    /* Ajustes para mobile */
    @media (max-width: 640px) {
      .hide-on-mobile {
        display: none;
      }
    }
    
    /* Scrollbar customizada */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: #8A05BE;
      border-radius: 3px;
    }
  </style>
  
  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- √çcones Material -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ========== COMPONENTE PRINCIPAL ==========
    function App() {
      // Estados principais
      const [payments, setPayments] = React.useState(() => {
        try {
          const saved = localStorage.getItem('financas_payments');
          return saved ? JSON.parse(saved) : [];
        } catch {
          return [];
        }
      });
      
      const [selectedMonth, setSelectedMonth] = React.useState(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
      });
      
      const [showAddModal, setShowAddModal] = React.useState(false);
      const [editingPayment, setEditingPayment] = React.useState(null);
      const [formData, setFormData] = React.useState({
        title: '',
        amount: '',
        day: '',
        category: 'outros',
        paid: false,
        notes: ''
      });
      
      const [showMenu, setShowMenu] = React.useState(false);
      const [notification, setNotification] = React.useState({
        show: false,
        text: '',
        type: 'success'
      });

      // Efeitos
      React.useEffect(() => {
        localStorage.setItem('financas_payments', JSON.stringify(payments));
      }, [payments]);

      // Fun√ß√µes utilit√°rias
      const formatCurrency = (value) => {
        if (!value && value !== 0) return 'R$ 0,00';
        return Number(value).toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        });
      };

      const parseCurrencyInput = (input) => {
        if (!input) return 0;
        // Remove tudo exceto n√∫meros, v√≠rgula e ponto
        const cleaned = input.replace(/[^\d,.-]/g, '');
        // Substitui v√≠rgula por ponto para parseFloat
        const normalized = cleaned.replace(',', '.');
        const value = parseFloat(normalized);
        return isNaN(value) ? 0 : value;
      };

      const formatDate = (isoString) => {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleDateString('pt-BR');
      };

      const changeMonth = (direction) => {
        const [year, month] = selectedMonth.split('-').map(Number);
        const newDate = new Date(year, month - 1 + direction, 1);
        const newYear = newDate.getFullYear();
        const newMonth = String(newDate.getMonth() + 1).padStart(2, '0');
        setSelectedMonth(`${newYear}-${newMonth}`);
      };

      const getMonthName = () => {
        const [year, month] = selectedMonth.split('-').map(Number);
        const date = new Date(year, month - 1, 1);
        return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      };

      const getPaymentsForMonth = () => {
        return payments.filter(payment => {
          if (!payment.dueDate) return false;
          const paymentDate = new Date(payment.dueDate);
          const paymentMonth = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
          return paymentMonth === selectedMonth;
        });
      };

      const getTotals = () => {
        const monthPayments = getPaymentsForMonth();
        const total = monthPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
        const paid = monthPayments.filter(p => p.paid).reduce((sum, p) => sum + (p.amount || 0), 0);
        const pending = monthPayments.filter(p => !p.paid).reduce((sum, p) => sum + (p.amount || 0), 0);
        
        return { total, paid, pending };
      };

      // Fun√ß√µes de CRUD
      const handleAddPayment = () => {
        if (!formData.title.trim()) {
          showNotification('Informe uma descri√ß√£o', 'error');
          return;
        }

        const amount = parseCurrencyInput(formData.amount);
        if (amount <= 0) {
          showNotification('Informe um valor v√°lido', 'error');
          return;
        }

        const day = parseInt(formData.day) || new Date().getDate();
        const [year, month] = selectedMonth.split('-').map(Number);
        
        // Garantir que o dia seja v√°lido para o m√™s
        const lastDay = new Date(year, month, 0).getDate();
        const validDay = Math.min(Math.max(1, day), lastDay);

        const newPayment = {
          id: Date.now(),
          title: formData.title.trim(),
          amount: amount,
          dueDate: new Date(year, month - 1, validDay).toISOString(),
          category: formData.category,
          paid: formData.paid,
          notes: formData.notes,
          createdAt: new Date().toISOString()
        };

        if (editingPayment) {
          setPayments(prev => prev.map(p => 
            p.id === editingPayment.id ? newPayment : p
          ));
          showNotification('Pagamento atualizado!');
        } else {
          setPayments(prev => [...prev, newPayment]);
          showNotification('Pagamento adicionado!');
        }

        handleCloseModal();
      };

      const handleEditPayment = (payment) => {
        setEditingPayment(payment);
        const dueDate = new Date(payment.dueDate);
        setFormData({
          title: payment.title,
          amount: payment.amount.toFixed(2).replace('.', ','),
          day: dueDate.getDate().toString(),
          category: payment.category || 'outros',
          paid: payment.paid || false,
          notes: payment.notes || ''
        });
        setShowAddModal(true);
      };

      const handleDeletePayment = (paymentId) => {
        if (confirm('Tem certeza que deseja excluir este pagamento?')) {
          setPayments(prev => prev.filter(p => p.id !== paymentId));
          showNotification('Pagamento exclu√≠do!');
        }
      };

      const handleTogglePaid = (paymentId) => {
        setPayments(prev => prev.map(p => 
          p.id === paymentId ? { ...p, paid: !p.paid } : p
        ));
        showNotification('Status atualizado!');
      };

      const handleCloseModal = () => {
        setShowAddModal(false);
        setEditingPayment(null);
        setFormData({
          title: '',
          amount: '',
          day: '',
          category: 'outros',
          paid: false,
          notes: ''
        });
      };

      const showNotification = (text, type = 'success') => {
        setNotification({ show: true, text, type });
        setTimeout(() => {
          setNotification({ show: false, text: '', type: 'success' });
        }, 3000);
      };

      const exportData = () => {
        const data = {
          payments,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-financas-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('Backup exportado com sucesso!');
      };

      const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.payments && Array.isArray(data.payments)) {
              setPayments(data.payments);
              showNotification('Dados importados com sucesso!');
            } else {
              showNotification('Arquivo inv√°lido', 'error');
            }
          } catch (error) {
            showNotification('Erro ao importar arquivo', 'error');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const clearData = () => {
        if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODOS os dados. Tem certeza?')) {
          if (prompt('Digite "APAGAR" para confirmar:') === 'APAGAR') {
            setPayments([]);
            localStorage.removeItem('financas_payments');
            showNotification('Dados apagados com sucesso!');
          }
        }
      };

      // Categorias
      const categories = [
        { id: 'alimentacao', name: 'üçî Alimenta√ß√£o', color: '#00D68F' },
        { id: 'transporte', name: 'üöó Transporte', color: '#FFAA00' },
        { id: 'moradia', name: 'üè† Moradia', color: '#0095FF' },
        { id: 'lazer', name: 'üéÆ Lazer', color: '#FF3D71' },
        { id: 'saude', name: 'üíä Sa√∫de', color: '#8A05BE' },
        { id: 'educacao', name: 'üìö Educa√ß√£o', color: '#00CEC9' },
        { id: 'outros', name: 'üì¶ Outros', color: '#8C8C8C' }
      ];

      // C√°lculos
      const monthPayments = getPaymentsForMonth();
      const pendingPayments = monthPayments.filter(p => !p.paid);
      const paidPayments = monthPayments.filter(p => p.paid);
      const totals = getTotals();

      return (
        <div className="min-h-screen bg-gray-900 text-white">
          {/* Header */}
          <header className="glass-effect sticky top-0 z-40 px-4 py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="nubank-card w-10 h-10 rounded-xl flex items-center justify-center">
                  <span className="material-icons-round">payments</span>
                </div>
                <div>
                  <h1 className="font-bold text-lg">Finan√ßas</h1>
                  <p className="text-xs text-gray-400">{getMonthName()}</p>
                </div>
              </div>
              
              <div className="flex items-center space-x-2">
                <button 
                  onClick={() => changeMonth(-1)}
                  className="p-2 hover:bg-white/5 rounded-lg"
                >
                  <span className="material-icons-round">chevron_left</span>
                </button>
                <button 
                  onClick={() => changeMonth(1)}
                  className="p-2 hover:bg-white/5 rounded-lg"
                >
                  <span className="material-icons-round">chevron_right</span>
                </button>
                <button 
                  onClick={() => setShowMenu(!showMenu)}
                  className="p-2 hover:bg-white/5 rounded-lg"
                >
                  <span className="material-icons-round">menu</span>
                </button>
              </div>
            </div>
            
            {/* Menu Dropdown */}
            {showMenu && (
              <div className="absolute top-full right-4 mt-2 w-64 card-modern shadow-2xl slide-in-right">
                <div className="space-y-2 p-2">
                  <label className="flex items-center justify-between w-full p-3 hover:bg-white/5 rounded-lg cursor-pointer">
                    <span>Importar Backup</span>
                    <span className="material-icons-round">upload</span>
                    <input 
                      type="file" 
                      accept=".json" 
                      onChange={importData}
                      className="hidden" 
                    />
                  </label>
                  
                  <button 
                    onClick={exportData}
                    className="flex items-center justify-between w-full p-3 hover:bg-white/5 rounded-lg"
                  >
                    <span>Exportar Backup</span>
                    <span className="material-icons-round">download</span>
                  </button>
                  
                  <div className="border-t border-white/10 my-2"></div>
                  
                  <button 
                    onClick={clearData}
                    className="flex items-center justify-between w-full p-3 hover:bg-white/5 rounded-lg text-red-400"
                  >
                    <span>Limpar Todos os Dados</span>
                    <span className="material-icons-round">delete</span>
                  </button>
                </div>
              </div>
            )}
          </header>

          {/* Cards de Resumo */}
          <div className="p-4">
            <div className="grid grid-cols-2 gap-3 mb-6">
              <div className="nubank-card">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 rounded-lg bg-white/10">
                    <span className="material-icons-round">trending_up</span>
                  </div>
                  <div>
                    <p className="text-sm opacity-80">Saldo</p>
                    <p className="text-xl font-bold">
                      {formatCurrency(totals.paid - totals.pending)}
                    </p>
                  </div>
                </div>
                <p className="text-xs opacity-70">Pagas - Pendentes</p>
              </div>
              
              <div className="card-modern">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 rounded-lg bg-yellow-500/20">
                    <span className="material-icons-round text-yellow-400">receipt</span>
                  </div>
                  <div>
                    <p className="text-sm opacity-80">Pendentes</p>
                    <p className="text-xl font-bold text-yellow-400">
                      {formatCurrency(totals.pending)}
                    </p>
                  </div>
                </div>
                <p className="text-xs opacity-70">{pendingPayments.length} itens</p>
              </div>
              
              <div className="card-modern">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 rounded-lg bg-green-500/20">
                    <span className="material-icons-round text-green-400">check_circle</span>
                  </div>
                  <div>
                    <p className="text-sm opacity-80">Pagas</p>
                    <p className="text-xl font-bold text-green-400">
                      {formatCurrency(totals.paid)}
                    </p>
                  </div>
                </div>
                <p className="text-xs opacity-70">{paidPayments.length} itens</p>
              </div>
              
              <div className="card-modern">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 rounded-lg bg-purple-500/20">
                    <span className="material-icons-round text-purple-400">payments</span>
                  </div>
                  <div>
                    <p className="text-sm opacity-80">Total</p>
                    <p className="text-xl font-bold">
                      {formatCurrency(totals.total)}
                    </p>
                  </div>
                </div>
                <p className="text-xs opacity-70">Todas as despesas</p>
              </div>
            </div>

            {/* Lista de Pagamentos */}
            <div className="mb-20">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold">Pagamentos do M√™s</h2>
                <button 
                  onClick={() => setShowAddModal(true)}
                  className="btn-primary flex items-center space-x-2"
                >
                  <span className="material-icons-round">add</span>
                  <span>Novo</span>
                </button>
              </div>

              {pendingPayments.length > 0 && (
                <div className="mb-6">
                  <h3 className="text-sm font-medium text-yellow-400 mb-3 flex items-center">
                    <span className="material-icons-round mr-2">warning</span>
                    Pendentes ({pendingPayments.length})
                  </h3>
                  {pendingPayments.map(payment => (
                    <PaymentItem 
                      key={payment.id}
                      payment={payment}
                      categories={categories}
                      onTogglePaid={() => handleTogglePaid(payment.id)}
                      onEdit={() => handleEditPayment(payment)}
                      onDelete={() => handleDeletePayment(payment.id)}
                    />
                  ))}
                </div>
              )}

              {paidPayments.length > 0 && (
                <div>
                  <h3 className="text-sm font-medium text-green-400 mb-3 flex items-center">
                    <span className="material-icons-round mr-2">check_circle</span>
                    Pagas ({paidPayments.length})
                  </h3>
                  {paidPayments.map(payment => (
                    <PaymentItem 
                      key={payment.id}
                      payment={payment}
                      categories={categories}
                      onTogglePaid={() => handleTogglePaid(payment.id)}
                      onEdit={() => handleEditPayment(payment)}
                      onDelete={() => handleDeletePayment(payment.id)}
                    />
                  ))}
                </div>
              )}

              {monthPayments.length === 0 && (
                <div className="card-modern p-8 text-center">
                  <div className="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4">
                    <span className="material-icons-round text-2xl text-gray-400">receipt</span>
                  </div>
                  <h3 className="text-lg font-semibold mb-2">Nenhum pagamento</h3>
                  <p className="text-gray-400 mb-4">Adicione seu primeiro pagamento para come√ßar</p>
                  <button 
                    onClick={() => setShowAddModal(true)}
                    className="btn-primary"
                  >
                    Adicionar Pagamento
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Bot√£o Flutuante */}
          <button 
            onClick={() => setShowAddModal(true)}
            className="fixed bottom-6 right-6 btn-primary w-14 h-14 rounded-full flex items-center justify-center shadow-2xl z-30"
          >
            <span className="material-icons-round">add</span>
          </button>

          {/* Modal de Adicionar/Editar Pagamento */}
          {showAddModal && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
              <div className="card-modern w-full max-w-md max-h-[90vh] overflow-y-auto slide-in-right">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold">
                      {editingPayment ? 'Editar Pagamento' : 'Novo Pagamento'}
                    </h2>
                    <button 
                      onClick={handleCloseModal}
                      className="p-2 hover:bg-white/5 rounded-lg"
                    >
                      <span className="material-icons-round">close</span>
                    </button>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">Descri√ß√£o *</label>
                      <input
                        type="text"
                        placeholder="Ex: Supermercado, Conta de Luz..."
                        value={formData.title}
                        onChange={e => setFormData({...formData, title: e.target.value})}
                        className="input-modern"
                      />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Valor (R$) *</label>
                        <input
                          type="text"
                          placeholder="Ex: 150,90"
                          value={formData.amount}
                          onChange={e => setFormData({...formData, amount: e.target.value})}
                          className="input-modern"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Dia *</label>
                        <input
                          type="number"
                          placeholder="1-31"
                          value={formData.day}
                          onChange={e => setFormData({...formData, day: e.target.value})}
                          className="input-modern"
                          min="1"
                          max="31"
                        />
                      </div>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2">Categoria</label>
                      <select
                        value={formData.category}
                        onChange={e => setFormData({...formData, category: e.target.value})}
                        className="input-modern"
                      >
                        {categories.map(cat => (
                          <option key={cat.id} value={cat.id}>{cat.name}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2">Status</label>
                      <div className="flex space-x-2">
                        <button
                          type="button"
                          onClick={() => setFormData({...formData, paid: false})}
                          className={`flex-1 py-2 rounded-lg border ${
                            !formData.paid
                              ? 'border-red-500 bg-red-500/10 text-red-400'
                              : 'border-white/10 hover:border-white/20'
                          }`}
                        >
                          Pendente
                        </button>
                        <button
                          type="button"
                          onClick={() => setFormData({...formData, paid: true})}
                          className={`flex-1 py-2 rounded-lg border ${
                            formData.paid
                              ? 'border-green-500 bg-green-500/10 text-green-400'
                              : 'border-white/10 hover:border-white/20'
                          }`}
                        >
                          Pago
                        </button>
                      </div>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2">Observa√ß√µes (opcional)</label>
                      <textarea
                        placeholder="Adicione observa√ß√µes..."
                        value={formData.notes}
                        onChange={e => setFormData({...formData, notes: e.target.value})}
                        rows="3"
                        className="input-modern resize-none"
                      />
                    </div>
                  </div>
                  
                  <div className="flex space-x-3 mt-8">
                    <button
                      onClick={handleAddPayment}
                      className="btn-primary flex-1 py-3"
                    >
                      {editingPayment ? 'Atualizar' : 'Salvar'}
                    </button>
                    <button
                      onClick={handleCloseModal}
                      className="btn-secondary flex-1 py-3"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Notifica√ß√£o */}
          {notification.show && (
            <div className={`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 fade-in ${
              notification.type === 'error' ? 'bg-red-500' :
              notification.type === 'warning' ? 'bg-yellow-500' :
              'bg-green-500'
            }`}>
              <div className="flex items-center space-x-2">
                {notification.type === 'error' && (
                  <span className="material-icons-round">error</span>
                )}
                {notification.type === 'warning' && (
                  <span className="material-icons-round">warning</span>
                )}
                {notification.type === 'success' && (
                  <span className="material-icons-round">check_circle</span>
                )}
                <span>{notification.text}</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ========== COMPONENTE DE ITEM DE PAGAMENTO ==========
    function PaymentItem({ payment, categories, onTogglePaid, onEdit, onDelete }) {
      const category = categories.find(c => c.id === payment.category) || categories.find(c => c.id === 'outros');
      
      return (
        <div className="card-modern mb-3 fade-in">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <button 
                onClick={onTogglePaid}
                className={`w-8 h-8 rounded-full flex items-center justify-center ${
                  payment.paid 
                    ? 'bg-green-500' 
                    : 'border-2 border-yellow-500'
                }`}
              >
                {payment.paid && (
                  <span className="material-icons-round text-white text-sm">check</span>
                )}
              </button>
              
              <div className="flex-1 min-w-0">
                <div className="flex items-center space-x-2">
                  <div 
                    className="w-2 h-2 rounded-full"
                    style={{ backgroundColor: category.color }}
                  />
                  <h3 className={`font-semibold truncate ${payment.paid ? 'line-through opacity-60' : ''}`}>
                    {payment.title}
                  </h3>
                </div>
                
                <div className="flex items-center space-x-3 mt-1 text-sm text-gray-400">
                  <span>{formatDate(payment.dueDate)}</span>
                  <span>‚Ä¢</span>
                  <span>{category.name}</span>
                </div>
                
                {payment.notes && (
                  <p className="text-sm text-gray-400 mt-2">{payment.notes}</p>
                )}
              </div>
            </div>
            
            <div className="flex items-center space-x-2">
              <span className={`text-lg font-semibold ${payment.paid ? 'opacity-60' : ''}`}>
                {formatCurrency(payment.amount)}
              </span>
              
              <div className="flex space-x-1">
                <button 
                  onClick={onEdit}
                  className="p-1 hover:bg-white/5 rounded"
                >
                  <span className="material-icons-round text-gray-400 text-lg">edit</span>
                </button>
                <button 
                  onClick={onDelete}
                  className="p-1 hover:bg-white/5 rounded"
                >
                  <span className="material-icons-round text-gray-400 text-lg">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Fun√ß√£o helper dentro do componente
    function formatDate(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toLocaleDateString('pt-BR');
    }

    function formatCurrency(value) {
      if (!value && value !== 0) return 'R$ 0,00';
      return Number(value).toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    // ========== RENDERIZA√á√ÉO ==========
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5" />
  <title>Controle de Finan√ßas V3.3 - Responsivo</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    /* Anima√ß√µes e estilos gerais */
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* Estilos responsivos para mobile */
    @media (max-width: 640px) {
      .mobile-col { flex-direction: column; }
      .mobile-text-sm { font-size: 0.875rem; }
      .mobile-p-2 { padding: 0.5rem; }
      .mobile-w-full { width: 100%; }
      .mobile-space-y-2 > * + * { margin-top: 0.5rem; }
      .mobile-hidden { display: none; }
      .mobile-flex-col { flex-direction: column; }
      .mobile-text-center { text-align: center; }
    }
    
    /* Melhorias de toque para mobile */
    button, input, select, textarea {
      touch-action: manipulation;
    }
    
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Ajustes de scroll para modal mobile */
    .modal-content {
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevenir zoom em inputs no iOS */
    @media (max-width: 768px) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }
    
    /* Estilos para cores dos cart√µes */
    .card-color-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    
    /* Estilos para o modal de PDF */
    .pdf-modal {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Ajuste para telas muito pequenas */
    @media (max-width: 360px) {
      .text-xs-responsive {
        font-size: 0.75rem;
      }
      .text-sm-responsive {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // √çCONES ADICIONAIS
    const Lock = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>);
    const Unlock = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>);
    
    // √çcones Originais
    const Plus = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>);
    const Download = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M12 12v9m0-9l-4 4m4-4l4 4" /></svg>);
    const Upload = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5-5 5 5M12 5v14" /></svg>);
    const Left = () => (<svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>);
    const Right = () => (<svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>);
    const ChartIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>);
    const Sun = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>);
    const Moon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>);
    const DashboardIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2zm0 4h16M7 15h2m4 0h2" /></svg>);
    const HistoryIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
    const CreditCardIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>);
    const XIcon = () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>);
    const PDFIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
    const MenuIcon = () => (<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>);
    const CloseIcon = () => (<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>);

    const CATEGORIES = [
      { id: 'mercantil', name: 'üõí Mercantil', color: '#10b981', bgColor: 'bg-emerald-500', darkBgColor: 'bg-emerald-600', featured: true },
      { id: 'lanches', name: 'üçï Lanches', color: '#f59e0b', bgColor: 'bg-amber-500', darkBgColor: 'bg-amber-600', featured: true },
      { id: 'combustivel', name: '‚õΩ Combust√≠vel', color: '#ef4444', bgColor: 'bg-red-500', darkBgColor: 'bg-red-600', featured: true },
      { id: 'cartao', name: 'üí≥ Cart√£o de Cr√©dito', color: '#8b5cf6', bgColor: 'bg-purple-500', darkBgColor: 'bg-purple-600', featured: true },
      { id: 'dizimos_ofertas', name: '‚õ™ D√≠zimos e Ofertas', color: '#fbbf24', bgColor: 'bg-yellow-500', darkBgColor: 'bg-yellow-600' },
      { id: 'mei', name: 'üè≠ MEI', color: '#a16207', bgColor: 'bg-yellow-700', darkBgColor: 'bg-yellow-800' },
      { id: 'moradia', name: 'üè† Moradia', color: '#3b82f6', bgColor: 'bg-blue-500', darkBgColor: 'bg-blue-600' },
      { id: 'alimentacao', name: 'üçî Alimenta√ß√£o', color: '#10b981', bgColor: 'bg-green-500', darkBgColor: 'bg-green-600' },
      { id: 'transporte', name: 'üöó Transporte', color: '#f59e0b', bgColor: 'bg-yellow-500', darkBgColor: 'bg-yellow-600' },
      { id: 'saude', name: 'üíä Sa√∫de', color: '#ef4444', bgColor: 'bg-pink-500', darkBgColor: 'bg-pink-600' },
      { id: 'educacao', name: 'üìö Educa√ß√£o', color: '#8b5cf6', bgColor: 'bg-indigo-500', darkBgColor: 'bg-indigo-600' },
      { id: 'lazer', name: 'üéÆ Lazer', color: '#ec4899', bgColor: 'bg-rose-500', darkBgColor: 'bg-rose-600' },
      { id: 'vestuario', name: 'üëï Vestu√°rio', color: '#06b6d4', bgColor: 'bg-cyan-500', darkBgColor: 'bg-cyan-600' },
      { id: 'outros', name: 'üì¶ Outros', color: '#6b7280', bgColor: 'bg-gray-500', darkBgColor: 'bg-gray-600' }
    ];

    // PALETA DE CORES PR√â-DEFINIDAS PARA CART√ïES
    const CARD_COLORS = [
      '#3B82F6', // Azul
      '#10B981', // Verde
      '#F59E0B', // √Çmbar
      '#EF4444', // Vermelho
      '#8B5CF6', // Violeta
      '#EC4899', // Rosa
      '#06B6D4', // Ciano
      '#84CC16', // Lima
      '#F97316', // Laranja
      '#6366F1', // √çndigo
      '#14B8A6', // Turquesa
      '#8B5CF6', // Roxo
      '#F43F5E', // Rosa escuro
      '#0EA5E9', // Azul claro
      '#A855F7'  // Roxo claro
    ];

    const SECTION_COLORS = {
      entradas: { light: { bg: 'bg-green-50', border: 'border-green-200', header: 'bg-green-500', text: 'text-green-900' }, dark: { bg: 'bg-green-900/20', border: 'border-green-800', header: 'bg-green-600', text: 'text-green-100' } },
      reservas: { light: { bg: 'bg-blue-50', border: 'border-blue-200', header: 'bg-blue-500', text: 'text-blue-900' }, dark: { bg: 'bg-blue-900/20', border: 'border-blue-800', header: 'bg-blue-600', text: 'text-blue-100' } },
      contas: { light: { bg: 'bg-amber-50', border: 'border-amber-200', header: 'bg-amber-500', text: 'text-amber-900' }, dark: { bg: 'bg-amber-900/20', border: 'border-amber-800', header: 'bg-amber-600', text: 'text-amber-100' } },
      quinzena1: { light: { bg: 'bg-blue-50', border: 'border-blue-200', header: 'bg-blue-500', text: 'text-blue-900' }, dark: { bg: 'bg-blue-900/20', border: 'border-blue-800', header: 'bg-blue-600', text: 'text-blue-100' } },
      quinzena2: { light: { bg: 'bg-purple-50', border: 'border-purple-200', header: 'bg-purple-500', text: 'text-purple-900' }, dark: { bg: 'bg-purple-900/20', border: 'border-purple-800', header: 'bg-purple-600', text: 'text-purple-100' } }
    };

    const parseCurrencyInput = (input) => {
      if (!input || input === '') return '';
      let expression = input.toString().replace(/\s+/g, '');
      const hasOperators = /[+\-*\/]/.test(expression);
      if (!hasOperators) {
        const num = parseFloat(expression.replace(',', '.'));
        return isNaN(num) ? '' : num;
      }
      try {
        // Substituir v√≠rgulas por pontos e remover pontos de milhar
        expression = expression.replace(/\./g, '').replace(/,/g, '.');
        // Avaliar de forma segura
        const result = eval(expression);
        return Math.round(result * 100) / 100;
      } catch (error) {
        console.error('Erro no c√°lculo:', error);
        return '';
      }
    };

    const formatNumberForInput = (num) => {
      if (num === '' || num === null || isNaN(Number(num))) return '';
      return String(num).replace('.', ',');
    };

    const formatDateDisplay = (iso) => {
      if (!iso) return '';
      const d = new Date(iso);
      const day = String(d.getDate()).padStart(2,'0');
      const month = String(d.getMonth() + 1).padStart(2,'0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    };

    const isoFromDateInput = (value) => value ? new Date(value + 'T12:00:00').toISOString() : '';

    const currencyFormat = (num) => {
      if (num === '' || num === null || isNaN(Number(num))) return 'R$ 0,00';
      return Number(num).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    const monthFromKey = (key) => {
      const [y,m] = key.split('-');
      return new Date(Number(y), Number(m)-1, 1);
    };

    const getAccountMonths = (account) => {
      if (!account.monthlyBalances || Object.keys(account.monthlyBalances).length === 0) return [];
      return Object.keys(account.monthlyBalances).sort((a, b) => {
        const [aYear, aMonth] = a.split('-').map(Number);
        const [bYear, bMonth] = b.split('-').map(Number);
        if (aYear !== bYear) return bYear - aYear;
        return bMonth - aMonth;
      });
    };

    const formatMonthKey = (key) => {
      const [year, month] = key.split('-').map(Number);
      const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      return `${monthNames[month-1]}/${year}`;
    };

    // FUN√á√ÉO PARA GERAR PDF
    const generatePDF = (data, options) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configura√ß√µes
      const pageWidth = doc.internal.pageSize.width;
      const margin = 20;
      const contentWidth = pageWidth - 2 * margin;
      
      // Cor de destaque
      const primaryColor = [41, 128, 185]; // Azul
      const secondaryColor = [52, 152, 219]; // Azul claro
      const successColor = [39, 174, 96]; // Verde
      const dangerColor = [231, 76, 60]; // Vermelho
      const warningColor = [243, 156, 18]; // Laranja
      const grayColor = [127, 140, 141]; // Cinza
      
      // Adicionar cabe√ßalho
      doc.setFillColor(...primaryColor);
      doc.rect(0, 0, pageWidth, 60, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(28);
      doc.setFont('helvetica', 'bold');
      doc.text('Relat√≥rio Financeiro', pageWidth / 2, 25, { align: 'center' });
      
      doc.setFontSize(14);
      doc.setFont('helvetica', 'normal');
      doc.text(`Per√≠odo: ${data.period}`, pageWidth / 2, 40, { align: 'center' });
      doc.text(`Gerado em: ${data.generatedDate}`, pageWidth / 2, 48, { align: 'center' });
      
      let yPos = 80;
      
      // 1. RESUMO FINANCEIRO
      doc.setFontSize(18);
      doc.setTextColor(...primaryColor);
      doc.setFont('helvetica', 'bold');
      doc.text('Resumo Financeiro', margin, yPos);
      
      yPos += 10;
      doc.setLineWidth(0.5);
      doc.setDrawColor(...primaryColor);
      doc.line(margin, yPos, margin + 50, yPos);
      
      yPos += 15;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      
      // Criar tabela de resumo
      const summaryData = [
        ['Total de Entradas', currencyFormat(data.summary.totalEntries)],
        ['Total de Despesas', currencyFormat(data.summary.totalExpenses)],
        ['Saldo do M√™s', currencyFormat(data.summary.monthBalance)],
        ['Contas Pagas', `${data.summary.paidCount} / ${data.summary.totalCount}`],
        ['Valor Pago', currencyFormat(data.summary.paidAmount)],
        ['Valor Pendente', currencyFormat(data.summary.pendingAmount)]
      ];
      
      summaryData.forEach(([label, value], index) => {
        doc.setFont('helvetica', 'bold');
        doc.text(label, margin, yPos);
        doc.setFont('helvetica', 'normal');
        
        // Colorir valores importantes
        if (label.includes('Saldo')) {
          const color = data.summary.monthBalance >= 0 ? successColor : dangerColor;
          doc.setTextColor(...color);
        } else if (label.includes('Pendente')) {
          doc.setTextColor(...dangerColor);
        } else if (label.includes('Pago')) {
          doc.setTextColor(...successColor);
        } else {
          doc.setTextColor(0, 0, 0);
        }
        
        doc.text(value, pageWidth - margin, yPos, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        yPos += 8;
      });
      
      yPos += 10;
      
      // 2. DESPESAS POR CATEGORIA (se solicitado)
      if (options.includeCategories && data.categories && data.categories.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Despesas por Categoria', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 70, yPos);
        
        yPos += 15;
        doc.setFontSize(10);
        
        // Tabela de categorias
        data.categories.forEach((cat, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          // Barra de progresso
          const barWidth = contentWidth * 0.6;
          const filledWidth = (cat.value / data.summary.totalExpenses) * barWidth;
          
          // Nome da categoria
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(cat.label, margin, yPos);
          
          // Valor
          doc.text(currencyFormat(cat.value), pageWidth - margin, yPos, { align: 'right' });
          
          yPos += 5;
          
          // Barra de progresso
          doc.setFillColor(230, 230, 230);
          doc.rect(margin, yPos, barWidth, 5, 'F');
          
          // Cor da barra baseada na categoria
          let barColor;
          if (cat.label.includes('Mercantil')) barColor = successColor;
          else if (cat.label.includes('Lanches')) barColor = warningColor;
          else if (cat.label.includes('Combust√≠vel')) barColor = dangerColor;
          else if (cat.label.includes('Cart√£o')) barColor = [155, 89, 182]; // Roxo
          else barColor = secondaryColor;
          
          doc.setFillColor(...barColor);
          doc.rect(margin, yPos, filledWidth, 5, 'F');
          
          // Porcentagem
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          const percentage = ((cat.value / data.summary.totalExpenses) * 100).toFixed(1);
          doc.text(`${percentage}%`, margin + barWidth + 5, yPos + 3.5);
          
          doc.setFontSize(10);
          yPos += 12;
        });
        
        yPos += 10;
      }
      
      // 3. CONTAS DO M√äS (se solicitado)
      if (options.includePayments && data.payments && data.payments.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Contas do M√™s', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 40, yPos);
        
        yPos += 15;
        doc.setFontSize(9);
        
        // Cabe√ßalho da tabela
        doc.setFillColor(240, 240, 240);
        doc.rect(margin, yPos, contentWidth, 8, 'F');
        
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Descri√ß√£o', margin + 2, yPos + 5.5);
        doc.text('Data', margin + contentWidth * 0.5, yPos + 5.5);
        doc.text('Valor', margin + contentWidth * 0.7, yPos + 5.5);
        doc.text('Status', margin + contentWidth * 0.85, yPos + 5.5);
        
        yPos += 10;
        
        // Linhas da tabela
        data.payments.forEach((payment, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          // Alternar cores das linhas
          if (index % 2 === 0) {
            doc.setFillColor(250, 250, 250);
            doc.rect(margin, yPos - 2, contentWidth, 8, 'F');
          }
          
          // Descri√ß√£o (truncada se muito longa)
          let description = payment.title;
          if (description.length > 30) {
            description = description.substring(0, 27) + '...';
          }
          
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0, 0, 0);
          doc.text(description, margin + 2, yPos + 5.5);
          
          // Data
          doc.text(payment.date, margin + contentWidth * 0.5, yPos + 5.5);
          
          // Valor
          doc.text(currencyFormat(payment.amount), margin + contentWidth * 0.7, yPos + 5.5);
          
          // Status
          if (payment.paid) {
            doc.setTextColor(...successColor);
            doc.text('Pago', margin + contentWidth * 0.85, yPos + 5.5);
          } else {
            doc.setTextColor(...dangerColor);
            doc.text('Pendente', margin + contentWidth * 0.85, yPos + 5.5);
          }
          
          yPos += 8;
        });
        
        yPos += 10;
      }
      
      // 4. CART√ïES DE CR√âDITO (se solicitado)
      if (options.includeCreditCards && data.creditCards && data.creditCards.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Cart√µes de Cr√©dito', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 60, yPos);
        
        yPos += 15;
        doc.setFontSize(10);
        
        data.creditCards.forEach((card, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(`${card.name} (Vence dia ${card.dueDay})`, margin, yPos);
          
          yPos += 7;
          
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...grayColor);
          doc.text(`Fatura do m√™s: ${currencyFormat(card.currentMonth)}`, margin + 10, yPos);
          
          yPos += 5;
          doc.text(`D√≠vida futura: ${currencyFormat(card.future)}`, margin + 10, yPos);
          
          yPos += 5;
          if (card.totalActiveDebt > 0) {
            doc.setTextColor(...dangerColor);
            doc.text(`Total pendente: ${currencyFormat(card.totalActiveDebt)}`, margin + 10, yPos);
            doc.setTextColor(...grayColor);
          }
          
          yPos += 10;
        });
        
        yPos += 5;
      }
      
      // 5. COMPRAS PARCELADAS (se solicitado)
      if (options.includeInstallments && data.installments && data.installments.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Compras Parceladas', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 60, yPos);
        
        yPos += 15;
        doc.setFontSize(9);
        
        data.installments.forEach((purchase, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(purchase.title, margin, yPos);
          
          yPos += 5;
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(...grayColor);
          doc.text(`Cart√£o: ${purchase.cardName} | ${purchase.paidCount}/${purchase.totalInstallments} parcelas`, margin + 5, yPos);
          
          yPos += 4;
          doc.text(`In√≠cio: ${purchase.startMonth} | Restam: ${currencyFormat(purchase.remainingAmount)}`, margin + 5, yPos);
          
          doc.setFontSize(9);
          yPos += 8;
        });
        
        yPos += 5;
      }
      
      // 6. CONTAS BANC√ÅRIAS (se solicitado)
      if (options.includeAccounts && data.accounts && data.accounts.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Contas Banc√°rias', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 55, yPos);
        
        yPos += 15;
        doc.setFontSize(10);
        
        data.accounts.forEach((account, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(account.name, margin, yPos);
          
          doc.setFont('helvetica', 'normal');
          const balanceColor = account.balance >= 0 ? successColor : dangerColor;
          doc.setTextColor(...balanceColor);
          doc.text(currencyFormat(account.balance), pageWidth - margin, yPos, { align: 'right' });
          
          doc.setTextColor(0, 0, 0);
          yPos += 8;
        });
        
        yPos += 5;
      }
      
      // 7. ENTRADAS (se solicitado)
      if (options.includeEntries && data.entries && data.entries.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Entradas do M√™s', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 55, yPos);
        
        yPos += 15;
        doc.setFontSize(10);
        
        data.entries.forEach((entry, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(entry.name, margin, yPos);
          
          yPos += 5;
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(...grayColor);
          doc.text(`Data: ${entry.date}`, margin + 5, yPos);
          
          doc.setFontSize(10);
          doc.setTextColor(...successColor);
          doc.text(currencyFormat(entry.amount), pageWidth - margin, yPos - 5, { align: 'right' });
          
          doc.setTextColor(0, 0, 0);
          yPos += 8;
        });
        
        yPos += 5;
      }
      
      // 8. RESERVAS (se solicitado)
      if (options.includeReservations && data.reservations && data.reservations.length > 0) {
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(18);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Reservas Financeiras', margin, yPos);
        
        yPos += 10;
        doc.setLineWidth(0.5);
        doc.setDrawColor(...primaryColor);
        doc.line(margin, yPos, margin + 65, yPos);
        
        yPos += 15;
        doc.setFontSize(10);
        
        data.reservations.forEach((reservation, index) => {
          if (yPos > 270) { doc.addPage(); yPos = 20; }
          
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text(reservation.name, margin, yPos);
          
          yPos += 5;
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(...grayColor);
          doc.text(`Data: ${reservation.date}`, margin + 5, yPos);
          
          doc.setFontSize(10);
          doc.setTextColor(52, 152, 219); // Azul
          doc.text(currencyFormat(reservation.amount), pageWidth - margin, yPos - 5, { align: 'right' });
          
          doc.setTextColor(0, 0, 0);
          yPos += 8;
        });
      }
      
      // Adicionar rodap√©
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        
        // N√∫mero da p√°gina
        doc.setFontSize(10);
        doc.setTextColor(...grayColor);
        doc.text(
          `P√°gina ${i} de ${totalPages}`,
          pageWidth / 2,
          doc.internal.pageSize.height - 10,
          { align: 'center' }
        );
        
        // Linha do rodap√©
        doc.setLineWidth(0.5);
        doc.setDrawColor(200, 200, 200);
        doc.line(
          margin,
          doc.internal.pageSize.height - 15,
          pageWidth - margin,
          doc.internal.pageSize.height - 15
        );
      }
      
      // Salvar o PDF
      const fileName = `relatorio-financeiro-${data.period.replace('/', '-')}.pdf`;
      doc.save(fileName);
    };

    // COMPONENTE PARA PREVIEW DO PDF
    const PDFPreviewModal = ({ data, options, darkMode, onClose, onGenerate }) => {
      if (!data) return null;
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className={`w-full max-w-4xl rounded-lg shadow-xl pdf-modal modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl md:text-2xl font-bold">Pr√©-visualiza√ß√£o do Relat√≥rio</h2>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 touch-target">
                  <XIcon />
                </button>
              </div>
              
              <div className="mb-6 p-4 rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20">
                <h3 className="font-bold text-blue-800 dark:text-blue-200 mb-2">Configura√ß√µes do Relat√≥rio</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                  {Object.entries(options).map(([key, value]) => {
                    let label = '';
                    switch(key) {
                      case 'includeCategories':
                        label = 'Categorias';
                        break;
                      case 'includePayments':
                        label = 'Contas';
                        break;
                      case 'includeCreditCards':
                        label = 'Cart√µes';
                        break;
                      case 'includeInstallments':
                        label = 'Parcelas';
                        break;
                      case 'includeAccounts':
                        label = 'Contas Banc√°rias';
                        break;
                      case 'includeEntries':
                        label = 'Entradas';
                        break;
                      case 'includeReservations':
                        label = 'Reservas';
                        break;
                      default:
                        label = key.replace('include', '').replace(/([A-Z])/g, ' $1').trim();
                    }
                    
                    return (
                      <div key={key} className="flex items-center">
                        <div className={`w-3 h-3 rounded-full mr-2 ${value ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <span>{label}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              <div className="space-y-6">
                {/* Cabe√ßalho */}
                <div className="text-center p-6 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white">
                  <h1 className="text-2xl md:text-3xl font-bold mb-2">Relat√≥rio Financeiro</h1>
                  <p className="text-base md:text-lg">Per√≠odo: {data.period}</p>
                  <p className="text-sm opacity-90">Gerado em: {data.generatedDate}</p>
                </div>
                
                {/* Resumo Financeiro */}
                <div className="p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                  <h3 className="text-lg md:text-xl font-bold mb-4 text-blue-600 dark:text-blue-400">Resumo Financeiro</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Total Entradas</p>
                      <p className="text-lg md:text-xl font-bold text-green-600 dark:text-green-400">{currencyFormat(data.summary.totalEntries)}</p>
                    </div>
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Total Despesas</p>
                      <p className="text-lg md:text-xl font-bold text-red-600 dark:text-red-400">{currencyFormat(data.summary.totalExpenses)}</p>
                    </div>
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Saldo do M√™s</p>
                      <p className={`text-lg md:text-xl font-bold ${data.summary.monthBalance >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                        {currencyFormat(data.summary.monthBalance)}
                      </p>
                    </div>
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Contas Pagas</p>
                      <p className="text-lg md:text-xl font-bold">{data.summary.paidCount} / {data.summary.totalCount}</p>
                    </div>
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Valor Pago</p>
                      <p className="text-lg md:text-xl font-bold text-green-600 dark:text-green-400">{currencyFormat(data.summary.paidAmount)}</p>
                    </div>
                    <div className="p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
                      <p className="text-sm text-gray-600 dark:text-gray-400">Valor Pendente</p>
                      <p className="text-lg md:text-xl font-bold text-yellow-600 dark:text-yellow-400">{currencyFormat(data.summary.pendingAmount)}</p>
                    </div>
                  </div>
                </div>
                
                {/* Despesas por Categoria */}
                {options.includeCategories && data.categories && data.categories.length > 0 && (
                  <div className="p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h3 className="text-lg md:text-xl font-bold mb-4 text-blue-600 dark:text-blue-400">Despesas por Categoria</h3>
                    <div className="space-y-3">
                      {data.categories.map((cat, index) => {
                        const percentage = data.summary.totalExpenses > 0 
                          ? ((cat.value / data.summary.totalExpenses) * 100).toFixed(1)
                          : 0;
                        
                        return (
                          <div key={index} className="space-y-1">
                            <div className="flex justify-between">
                              <span className="font-medium text-sm-responsive">{cat.label}</span>
                              <span className="font-bold">{currencyFormat(cat.value)}</span>
                            </div>
                            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                              <div 
                                className="h-2.5 rounded-full" 
                                style={{ 
                                  width: `${percentage}%`,
                                  backgroundColor: cat.color || '#3b82f6'
                                }}
                              ></div>
                            </div>
                            <div className="text-right text-sm text-gray-500 dark:text-gray-400">
                              {percentage}% do total
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                
                {/* Contas do M√™s */}
                {options.includePayments && data.payments && data.payments.length > 0 && (
                  <div className="p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h3 className="text-lg md:text-xl font-bold mb-4 text-blue-600 dark:text-blue-400">Contas do M√™s ({data.payments.length})</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b dark:border-gray-700">
                            <th className="text-left py-2 text-xs-responsive">Descri√ß√£o</th>
                            <th className="text-left py-2 text-xs-responsive">Data</th>
                            <th className="text-left py-2 text-xs-responsive">Valor</th>
                            <th className="text-left py-2 text-xs-responsive">Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {data.payments.slice(0, 5).map((payment, index) => (
                            <tr key={index} className="border-b dark:border-gray-700">
                              <td className="py-2 text-xs-responsive">{payment.title}</td>
                              <td className="py-2 text-xs-responsive">{payment.date}</td>
                              <td className="py-2 text-xs-responsive">{currencyFormat(payment.amount)}</td>
                              <td className="py-2 text-xs-responsive">
                                <span className={`px-2 py-1 rounded text-xs ${payment.paid ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                                  {payment.paid ? 'Pago' : 'Pendente'}
                                </span>
                              </td>
                            </tr>
                          ))}
                          {data.payments.length > 5 && (
                            <tr>
                              <td colSpan="4" className="py-2 text-center text-gray-500 dark:text-gray-400 text-xs-responsive">
                                ... e mais {data.payments.length - 5} conta(s)
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
                
                {/* Cart√µes de Cr√©dito */}
                {options.includeCreditCards && data.creditCards && data.creditCards.length > 0 && (
                  <div className="p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h3 className="text-lg md:text-xl font-bold mb-4 text-blue-600 dark:text-blue-400">Cart√µes de Cr√©dito</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {data.creditCards.map((card, index) => (
                        <div key={index} className="p-3 rounded-lg border border-gray-300 dark:border-gray-600">
                          <h4 className="font-bold mb-2 text-sm-responsive">{card.name}</h4>
                          <div className="space-y-1 text-sm">
                            <div className="flex justify-between">
                              <span>Vencimento:</span>
                              <span>Dia {card.dueDay}</span>
                            </div>
                            <div className="flex justify-between">
                              <span>Fatura deste m√™s:</span>
                              <span className="font-bold">{currencyFormat(card.currentMonth)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span>D√≠vida futura:</span>
                              <span>{currencyFormat(card.future)}</span>
                            </div>
                            {card.totalActiveDebt > 0 && (
                              <div className="flex justify-between">
                                <span>Total pendente:</span>
                                <span className="font-bold text-red-600 dark:text-red-400">{currencyFormat(card.totalActiveDebt)}</span>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Rodap√© */}
                <div className="p-4 rounded-lg border border-gray-300 dark:border-gray-600 text-center text-gray-500 dark:text-gray-400 text-sm">
                  <p>Este relat√≥rio foi gerado automaticamente pelo Sistema de Controle de Finan√ßas</p>
                  <p className="mt-1">Total de p√°ginas estimado: {Object.values(options).filter(v => v).length + 2}</p>
                </div>
              </div>
              
              <div className="mt-8 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button 
                  onClick={onGenerate}
                  className="flex-1 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition-colors flex items-center justify-center space-x-2 touch-target"
                >
                  <Download />
                  <span>Gerar e Baixar PDF</span>
                </button>
                <button 
                  onClick={onClose}
                  className="flex-1 py-3 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-bold transition-colors touch-target"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // COMPONENTE DE CONFIGURA√á√ÉO DO PDF
    const PDFConfigModal = ({ darkMode, onClose, onGenerate, defaultOptions }) => {
      const [options, setOptions] = useState(defaultOptions);
      
      const toggleOption = (option) => {
        setOptions(prev => ({
          ...prev,
          [option]: !prev[option]
        }));
      };
      
      const selectAll = () => {
        setOptions({
          includeCategories: true,
          includePayments: true,
          includeCreditCards: true,
          includeInstallments: true,
          includeAccounts: true,
          includeEntries: true,
          includeReservations: true,
        });
      };
      
      const deselectAll = () => {
        setOptions({
          includeCategories: false,
          includePayments: false,
          includeCreditCards: false,
          includeInstallments: false,
          includeAccounts: false,
          includeEntries: false,
          includeReservations: false,
        });
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className={`w-full max-w-md rounded-lg shadow-xl modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold">Gerar Relat√≥rio PDF</h2>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 touch-target">
                  <XIcon />
                </button>
              </div>
              
              <div className="mb-6">
                <p className="text-gray-600 dark:text-gray-400 mb-4">
                  Selecione as se√ß√µes que deseja incluir no relat√≥rio:
                </p>
                
                <div className="space-y-3">
                  {Object.entries(options).map(([key, value]) => {
                    let label = '';
                    switch(key) {
                      case 'includeCategories':
                        label = 'Categorias';
                        break;
                      case 'includePayments':
                        label = 'Contas do M√™s';
                        break;
                      case 'includeCreditCards':
                        label = 'Cart√µes de Cr√©dito';
                        break;
                      case 'includeInstallments':
                        label = 'Compras Parceladas';
                        break;
                      case 'includeAccounts':
                        label = 'Contas Banc√°rias';
                        break;
                      case 'includeEntries':
                        label = 'Entradas';
                        break;
                      case 'includeReservations':
                        label = 'Reservas';
                        break;
                      default:
                        label = key.replace('include', '').replace(/([A-Z])/g, ' $1').trim();
                    }
                    
                    return (
                      <div key={key} className="flex items-center justify-between p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                        <label className="flex items-center space-x-3 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={value}
                            onChange={() => toggleOption(key)}
                            className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <span className="font-medium">{label}</span>
                        </label>
                        <div className={`w-3 h-3 rounded-full ${value ? 'bg-green-500' : 'bg-red-500'}`}></div>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              <div className="flex space-x-3 mb-6">
                <button 
                  onClick={selectAll}
                  className="flex-1 py-2 rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 font-medium touch-target"
                >
                  Selecionar Tudo
                </button>
                <button 
                  onClick={deselectAll}
                  className="flex-1 py-2 rounded-lg bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-200 font-medium touch-target"
                >
                  Desmarcar Tudo
                </button>
              </div>
              
              <div className="flex space-x-3">
                <button 
                  onClick={() => onGenerate(options)}
                  className="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors touch-target"
                >
                  Gerar Relat√≥rio
                </button>
                <button 
                  onClick={onClose}
                  className="flex-1 py-3 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-bold transition-colors touch-target"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    function PieChart({ data, title }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current) return;
        if (chartRef.current) chartRef.current.destroy();
        const ctx = canvasRef.current.getContext('2d');
        chartRef.current = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: data.map(d => d.label),
            datasets: [{
              data: data.map(d => d.value),
              backgroundColor: data.map(d => d.color),
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } },
              title: { display: true, text: title, font: { size: 14, weight: 'bold' } }
            }
          }
        });
        return () => chartRef.current && chartRef.current.destroy();
      }, [data, title]);
      return <canvas ref={canvasRef} />;
    }

    function BarChart({ data, title }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current) return;
        if (chartRef.current) chartRef.current.destroy();
        const ctx = canvasRef.current.getContext('2d');
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [
              { label: 'Entradas', data: data.entries, backgroundColor: '#10b981', borderRadius: 4 },
              { label: 'Despesas', data: data.expenses, backgroundColor: '#ef4444', borderRadius: 4 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: title, font: { size: 14, weight: 'bold' } }
            },
            scales: { y: { beginAtZero: true, ticks: { callback: (value) => currencyFormat(value) } } }
          }
        });
        return () => chartRef.current && chartRef.current.destroy();
      }, [data, title]);
      return <canvas ref={canvasRef} />;
    }

    // === COMPONENTE DE LOGIN ===
    const LoginScreen = ({ onLogin, darkMode, hasPassword }) => {
      const [input, setInput] = useState('');
      const [error, setError] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        onLogin(input, setError);
      };

      return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gray-100'} p-4`}>
          <div className={`w-full max-w-sm p-8 rounded-xl shadow-2xl ${darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-800'} fade-in`}>
            <div className="flex justify-center mb-6">
              <div className={`p-4 rounded-full ${darkMode ? 'bg-blue-900/30' : 'bg-blue-100'}`}>
                <Lock />
              </div>
            </div>
            <h2 className="text-2xl font-bold text-center mb-2">Finan√ßas Bloqueado</h2>
            <p className="text-center text-sm mb-6 opacity-70">Digite sua senha para acessar</p>
            
            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <input
                  type="password"
                  value={input}
                  onChange={(e) => { setInput(e.target.value); setError(false); }}
                  className={`w-full px-4 py-3 rounded-lg border text-center text-lg tracking-widest touch-target ${
                    error 
                      ? 'border-red-500 focus:ring-red-500' 
                      : darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'
                  } focus:outline-none focus:ring-2 focus:ring-blue-500`}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  autoFocus
                />
                {error && <p className="text-red-500 text-xs text-center mt-2">Senha incorreta</p>}
              </div>
              <button
                type="submit"
                className="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors shadow-lg touch-target"
              >
                DESBLOQUEAR
              </button>
            </form>
            <div className="mt-6 text-center text-xs opacity-50">
              Esqueceu? Limpe os dados do navegador para resetar (aten√ß√£o: apaga tudo).
            </div>
          </div>
        </div>
      );
    };

    // Componente para sele√ß√£o de cor
    const ColorPicker = ({ selectedColor, onColorSelect }) => {
      return (
        <div className="space-y-3">
          <div className="text-sm font-medium">Escolha uma cor para o cart√£o:</div>
          <div className="grid grid-cols-5 gap-2">
            {CARD_COLORS.map((color, index) => (
              <button
                key={index}
                type="button"
                onClick={() => onColorSelect(color)}
                className={`w-8 h-8 rounded-full border-2 touch-target ${selectedColor === color ? 'border-gray-800 scale-110' : 'border-gray-300'}`}
                style={{ backgroundColor: color }}
                title={`Cor ${index + 1}`}
              />
            ))}
          </div>
          <div className="flex items-center space-x-2">
            <div className="w-4 h-4 rounded-full" style={{ backgroundColor: selectedColor }}></div>
            <span className="text-sm">Cor selecionada: {selectedColor}</span>
          </div>
        </div>
      );
    };

    function App(){
      // === ESTADOS DE AUTENTICA√á√ÉO ===
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [appPassword, setAppPassword] = useState(() => localStorage.getItem('financas_app_password') || null);
      const [showPasswordModal, setShowPasswordModal] = useState(false);
      const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });

      // Estado para menu mobile
      const [showMobileMenu, setShowMobileMenu] = useState(false);

      // Verificar autentica√ß√£o ao carregar
      useEffect(() => {
        if (!appPassword) {
          setIsAuthenticated(true);
        }
      }, [appPassword]);

      const handleLogin = (inputPassword, onError) => {
        if (btoa(inputPassword) === appPassword) {
          setIsAuthenticated(true);
        } else {
          onError(true);
        }
      };

      const handleSetPassword = () => {
        if (passwordForm.new !== passwordForm.confirm) {
          notify('As senhas n√£o coincidem', 'error');
          return;
        }
        if (passwordForm.new === '') {
          if (confirm('Tem certeza que deseja remover a prote√ß√£o por senha?')) {
            localStorage.removeItem('financas_app_password');
            setAppPassword(null);
            setShowPasswordModal(false);
            notify('Senha removida com sucesso!');
            setIsAuthenticated(true);
          }
          return;
        }
        
        const encoded = btoa(passwordForm.new);
        localStorage.setItem('financas_app_password', encoded);
        setAppPassword(encoded);
        setShowPasswordModal(false);
        setPasswordForm({ current: '', new: '', confirm: '' });
        notify('Senha configurada com sucesso!');
      };

      // === ESTADOS ORIGINAIS ===
      const [payments, setPayments] = useState(() => {
        const saved = localStorage.getItem('financas_payments');
        return saved ? JSON.parse(saved) : [];
      });
      const [templatesFixed, setTemplatesFixed] = useState(() => {
        const saved = localStorage.getItem('financas_templatesFixed');
        return saved ? JSON.parse(saved) : [];
      });
      const [entries, setEntries] = useState(() => {
        const saved = localStorage.getItem('financas_entries');
        return saved ? JSON.parse(saved) : [];
      });
      const [reservations, setReservations] = useState(() => {
        const saved = localStorage.getItem('financas_reservations');
        return saved ? JSON.parse(saved) : [];
      });
      const [selectedMonthKey, setSelectedMonthKey] = useState(() => {
        const saved = localStorage.getItem('financas_selectedMonthKey');
        if (saved) return saved;
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      });
      const [showAddPayment, setShowAddPayment] = useState(false);
      const [showAddEntry, setShowAddEntry] = useState(false);
      const [showAddReservation, setShowAddReservation] = useState(false);
      const [editingPayment, setEditingPayment] = useState(null);
      const [editingEntry, setEditingEntry] = useState(null);
      const [editingReservation, setEditingReservation] = useState(null);
      const [formPayment, setFormPayment] = useState({ title:'', amount:'', day:'', type:'variable', notes:'', category:'outros', paid: false, calculatedResult: '' });
      const [formEntry, setFormEntry] = useState({ name:'', amount:'', date:'', notes:'' });
      const [formReservation, setFormReservation] = useState({ name:'', amount:'', date:'', notes:'' });
      const [search, setSearch] = useState('');
      const [alertDaysBefore, setAlertDaysBefore] = useState(() => {
        const saved = localStorage.getItem('financas_alertDaysBefore');
        return saved ? Number(saved) : 3;
      });
      const [notification, setNotification] = useState({ show:false, text:'', type:'success' });
      const [reminders, setReminders] = useState([]);
      const [viewFilter, setViewFilter] = useState('month');
      const [showFixedAccounts, setShowFixedAccounts] = useState(false);
      const [showAnalytics, setShowAnalytics] = useState(false);
      const [categoryFilter, setCategoryFilter] = useState('all');
      const [categoryGoals, setCategoryGoals] = useState(() => {
        const saved = localStorage.getItem('financas_categoryGoals');
        return saved ? JSON.parse(saved) : {};
      });
      const [showGoalsManager, setShowGoalsManager] = useState(false);
      const [installments, setInstallments] = useState(() => {
        const saved = localStorage.getItem('financas_installments');
        return saved ? JSON.parse(saved) : [];
      });
      const [accounts, setAccounts] = useState(() => {
        const saved = localStorage.getItem('financas_accounts');
        if (saved) {
          const parsed = JSON.parse(saved);
          return parsed.map(account => {
            if (account.balance !== undefined && !account.monthlyBalances) {
              return { ...account, monthlyBalances: { [selectedMonthKey]: account.balance } };
            }
            if (!account.monthlyBalances) { return { ...account, monthlyBalances: {} }; }
            return account;
          });
        }
        return [];
      });
      const [showAddAccount, setShowAddAccount] = useState(false);
      const [editingAccount, setEditingAccount] = useState(null);
      const [formAccount, setFormAccount] = useState({ name:'', balance:'' });
      const [showAddInstallment, setShowAddInstallment] = useState(false);
      const [formInstallment, setFormInstallment] = useState({ title:'', totalAmount:'', installmentCount:'', firstDueDay:'', category:'outros', notes:'' });
      
      const [darkMode, setDarkMode] = useState(() => {
        const saved = localStorage.getItem('financas_darkMode');
        return saved ? JSON.parse(saved) : false;
      });
      const [showDashboard, setShowDashboard] = useState(false);
      const [showBudgetManager, setShowBudgetManager] = useState(false);
      const [categoryBudgets, setCategoryBudgets] = useState(() => {
        const saved = localStorage.getItem('financas_categoryBudgets');
        return saved ? JSON.parse(saved) : {};
      });

      const [sectionVisibility, setSectionVisibility] = useState(() => {
        const saved = localStorage.getItem('financas_sectionVisibility');
        return saved ? JSON.parse(saved) : { 
          accounts: true, 
          entries: true, 
          reservations: true, 
          quinzena1: true, 
          quinzena2: true, 
          fixedAccounts: true,
          creditCardsSummary: true,
          creditCardsPurchases: true
        };
      });

      const [expandedCardGroups, setExpandedCardGroups] = useState(() => {
        const saved = localStorage.getItem('financas_expandedCardGroups');
        return saved ? JSON.parse(saved) : {};
      });

      const [showAccountHistory, setShowAccountHistory] = useState(null);

      const [creditCards, setCreditCards] = useState(() => {
        const saved = localStorage.getItem('financas_creditCards');
        if (saved) {
          const parsed = JSON.parse(saved);
          return parsed.map(card => {
            if (!card.color || card.color === '#') {
              return { ...card, color: CARD_COLORS[Math.floor(Math.random() * CARD_COLORS.length)] };
            }
            return card;
          });
        }
        return [];
      });

      const [creditCardPurchases, setCreditCardPurchases] = useState(() => {
        const saved = localStorage.getItem('financas_creditCardPurchases');
        return saved ? JSON.parse(saved) : [];
      });

      const [editingCreditPurchase, setEditingCreditPurchase] = useState(null);

      const [showCreditCards, setShowCreditCards] = useState(false);
      const [showAddCreditCard, setShowAddCreditCard] = useState(false);
      const [showAddCreditPurchase, setShowAddCreditPurchase] = useState(false);
      const [editingCreditCard, setEditingCreditCard] = useState(null);
      const [formCreditCard, setFormCreditCard] = useState({ name: '', dueDay: '', color: CARD_COLORS[0] });
      const [formCreditPurchase, setFormCreditPurchase] = useState({ title: '', totalAmount: '', installmentCount: '', firstDueMonth: selectedMonthKey, cardId: '', category: 'cartao' });

      // NOVOS ESTADOS PARA PDF
      const [showPDFConfig, setShowPDFConfig] = useState(false);
      const [showPDFPreview, setShowPDFPreview] = useState(false);
      const [pdfData, setPdfData] = useState(null);
      const [pdfOptions, setPdfOptions] = useState({
        includeCategories: true,
        includePayments: true,
        includeCreditCards: true,
        includeInstallments: true,
        includeAccounts: true,
        includeEntries: true,
        includeReservations: true,
      });

      const daysInMonth = (year, monthIndex) => new Date(year, monthIndex+1, 0).getDate();

      const monthKeyFromIso = (iso) => {
        if (!iso) return null;
        const d = new Date(iso);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      };

      const getLightColor = (hexColor) => {
        return hexColor + '10';
      };

      const getBorderColor = (hexColor) => {
        return hexColor + '40';
      };

      const getTextColorClass = (hexColor) => {
        return 'text-gray-800 dark:text-gray-200';
      };

      useEffect(() => {
        if (darkMode) {
          document.body.classList.add('dark');
        } else {
          document.body.classList.remove('dark');
        }
      }, [darkMode]);

      useEffect(() => { localStorage.setItem('financas_payments', JSON.stringify(payments)); }, [payments]);
      useEffect(() => { localStorage.setItem('financas_templatesFixed', JSON.stringify(templatesFixed)); }, [templatesFixed]);
      useEffect(() => { localStorage.setItem('financas_entries', JSON.stringify(entries)); }, [entries]);
      useEffect(() => { localStorage.setItem('financas_reservations', JSON.stringify(reservations)); }, [reservations]);
      useEffect(() => { localStorage.setItem('financas_selectedMonthKey', selectedMonthKey); }, [selectedMonthKey]);
      useEffect(() => { localStorage.setItem('financas_alertDaysBefore', String(alertDaysBefore)); }, [alertDaysBefore]);
      useEffect(() => { localStorage.setItem('financas_categoryGoals', JSON.stringify(categoryGoals)); }, [categoryGoals]);
      useEffect(() => { localStorage.setItem('financas_installments', JSON.stringify(installments)); }, [installments]);
      useEffect(() => { localStorage.setItem('financas_accounts', JSON.stringify(accounts)); }, [accounts]);
      useEffect(() => { localStorage.setItem('financas_darkMode', JSON.stringify(darkMode)); }, [darkMode]);
      useEffect(() => { localStorage.setItem('financas_categoryBudgets', JSON.stringify(categoryBudgets)); }, [categoryBudgets]);
      useEffect(() => { localStorage.setItem('financas_sectionVisibility', JSON.stringify(sectionVisibility)); }, [sectionVisibility]);
      useEffect(() => { localStorage.setItem('financas_creditCards', JSON.stringify(creditCards)); }, [creditCards]);
      useEffect(() => { localStorage.setItem('financas_creditCardPurchases', JSON.stringify(creditCardPurchases)); }, [creditCardPurchases]);
      useEffect(() => { localStorage.setItem('financas_expandedCardGroups', JSON.stringify(expandedCardGroups)); }, [expandedCardGroups]);

      // FUN√á√ÉO PARA PREPARAR DADOS DO PDF
      const preparePDFData = () => {
        const pays = getFilteredPaymentsForMonth(selectedMonthKey);
        const ents = getEntriesForMonth(selectedMonthKey);
        const resvs = reservations;
        
        // Resumo financeiro
        const totalEntries = ents.reduce((sum, e) => sum + Number(e.amount || 0), 0);
        const totalExpenses = pays.reduce((sum, p) => sum + Number(p.amount || 0), 0);
        const paidPayments = pays.filter(p => p.paid);
        const pendingPayments = pays.filter(p => !p.paid);
        
        // Dados das categorias
        const categoryTotals = {};
        CATEGORIES.forEach(cat => {
          categoryTotals[cat.id] = pays.filter(p => p.category === cat.id).reduce((sum, p) => sum + Number(p.amount || 0), 0);
        });
        
        const categoriesData = CATEGORIES.map(cat => ({
          label: cat.name,
          value: categoryTotals[cat.id],
          color: cat.color
        })).filter(d => d.value > 0);
        
        // Dados dos cart√µes de cr√©dito
        const cardTotals = getCardTotals();
        const creditCardsData = creditCards.filter(card => card.active).map(card => {
          const totals = cardTotals[card.id] || { currentMonth: 0, future: 0, totalActiveDebt: 0 };
          return {
            name: card.name,
            dueDay: card.dueDay,
            currentMonth: totals.currentMonth,
            future: totals.future,
            totalActiveDebt: totals.totalActiveDebt
          };
        });
        
        // Compras parceladas
        const installmentsData = creditCardPurchases
          .filter(p => p.installments.some(inst => !inst.paid))
          .map(purchase => {
            const card = creditCards.find(c => c.id === purchase.cardId);
            const paidCount = purchase.installments.filter(inst => inst.paid).length;
            const remainingAmount = purchase.installments
              .filter(inst => !inst.paid)
              .reduce((sum, inst) => sum + inst.amount, 0);
            
            return {
              title: purchase.title,
              cardName: card ? card.name : 'Cart√£o Desconhecido',
              totalInstallments: purchase.installmentCount,
              paidCount,
              remainingAmount,
              startMonth: formatMonthKey(purchase.firstDueMonth)
            };
          });
        
        // Contas banc√°rias
        const accountsData = accounts.map(account => ({
          name: account.name,
          balance: account.monthlyBalances?.[selectedMonthKey] || 0
        }));
        
        // Entradas
        const entriesData = ents.map(entry => ({
          name: entry.name,
          amount: entry.amount,
          date: formatDateDisplay(entry.date)
        }));
        
        // Reservas
        const reservationsData = resvs.map(reservation => ({
          name: reservation.name,
          amount: reservation.amount,
          date: formatDateDisplay(reservation.date)
        }));
        
        return {
          period: formatMonthKey(selectedMonthKey),
          generatedDate: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
          summary: {
            totalEntries,
            totalExpenses,
            monthBalance: totalEntries - totalExpenses,
            paidCount: paidPayments.length,
            totalCount: pays.length,
            paidAmount: paidPayments.reduce((sum, p) => sum + Number(p.amount || 0), 0),
            pendingAmount: pendingPayments.reduce((sum, p) => sum + Number(p.amount || 0), 0)
          },
          categories: categoriesData,
          payments: pays.map(p => ({
            title: p.title,
            amount: p.amount,
            date: formatDateDisplay(p.dueDateIso),
            paid: p.paid,
            category: CATEGORIES.find(c => c.id === p.category)?.name || p.category
          })),
          creditCards: creditCardsData,
          installments: installmentsData,
          accounts: accountsData,
          entries: entriesData,
          reservations: reservationsData
        };
      };

      // FUN√á√ÉO PARA GERAR RELAT√ìRIO
      const handleGeneratePDF = (options) => {
        const data = preparePDFData();
        setPdfData(data);
        setPdfOptions(options);
        setShowPDFConfig(false);
        setShowPDFPreview(true);
      };

      // FUN√á√ÉO PARA GERAR E BAIXAR PDF
      const handleDownloadPDF = () => {
        generatePDF(pdfData, pdfOptions);
        setShowPDFPreview(false);
        notify('PDF gerado com sucesso!');
      };

      const toggleSection = (section) => {
        setSectionVisibility(prev => ({ ...prev, [section]: !prev[section] }));
      };

      const toggleCardGroup = (cardId) => {
        setExpandedCardGroups(prev => ({
          ...prev,
          [cardId]: !prev[cardId]
        }));
      };

      // FUN√á√ÉO ATUALIZADA: Gera parcelas apenas para meses futuros
      const generateInstallments = (purchaseData, card) => {
        const installments = [];
        const installmentAmount = purchaseData.totalAmount / purchaseData.installmentCount;
        const [startYear, startMonth] = purchaseData.firstDueMonth.split('-').map(Number);
        
        for (let i = 0; i < purchaseData.installmentCount; i++) {
          const monthOffset = i;
          const date = new Date(startYear, startMonth - 1 + monthOffset, 1);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const monthKey = `${year}-${String(month).padStart(2, '0')}`;
          
          // S√≥ cria a parcela se for m√™s futuro (maior ou igual ao m√™s atual de cria√ß√£o)
          const currentDate = new Date();
          const currentMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
          
          // Compara as chaves de m√™s para ver se √© futuro
          if (monthKey >= currentMonthKey) {
            installments.push({ 
              monthKey, 
              amount: installmentAmount, 
              paid: false, 
              dueDay: card.dueDay,
              createdAt: new Date().toISOString() // Adiciona data de cria√ß√£o
            });
          }
        }
        return installments;
      };

      const addCreditCard = () => {
        if (!formCreditCard.name.trim()) { notify('Informe o nome do cart√£o', 'error'); return; }
        if (!formCreditCard.dueDay || formCreditCard.dueDay < 1 || formCreditCard.dueDay > 31) { notify('Informe um dia v√°lido', 'error'); return; }
        
        const newCard = { 
          id: Date.now() + Math.floor(Math.random() * 1000), 
          name: formCreditCard.name.trim(), 
          dueDay: Number(formCreditCard.dueDay), 
          color: formCreditCard.color, 
          active: true 
        };
        setCreditCards(prev => [...prev, newCard]);
        setFormCreditCard({ name: '', dueDay: '', color: CARD_COLORS[0] });
        setShowAddCreditCard(false);
        notify('Cart√£o adicionado!');
      };

      const updateCreditCard = () => {
        if (!editingCreditCard) return;
        if (!formCreditCard.name.trim()) { notify('Informe o nome', 'error'); return; }
        setCreditCards(prev => prev.map(card => card.id === editingCreditCard.id ? { ...card, name: formCreditCard.name.trim(), dueDay: Number(formCreditCard.dueDay), color: formCreditCard.color } : card));
        setEditingCreditCard(null);
        setFormCreditCard({ name: '', dueDay: '', color: CARD_COLORS[0] });
        setShowAddCreditCard(false);
        notify('Cart√£o atualizado!');
      };

      const deleteCreditCard = (cardId) => {
        if (!confirm('Excluir este cart√£o? Todas as compras parceladas vinculadas tamb√©m ser√£o exclu√≠das.')) return;
        setCreditCards(prev => prev.filter(card => card.id !== cardId));
        const purchasesToDelete = creditCardPurchases.filter(p => p.cardId === cardId);
        purchasesToDelete.forEach(purchase => {
          setPayments(prev => prev.filter(p => p.creditPurchaseId !== purchase.id));
        });
        setCreditCardPurchases(prev => prev.filter(p => p.cardId !== cardId));
        notify('Cart√£o e compras vinculadas removidos!');
      };

      const deleteCreditPurchase = (purchaseId) => {
        if (!confirm('Excluir esta compra parcelada? Todas as parcelas pendentes e pagas ser√£o removidas.')) return;
        setCreditCardPurchases(prev => prev.filter(p => p.id !== purchaseId));
        setPayments(prev => prev.filter(p => p.creditPurchaseId !== purchaseId));
        notify('Compra parcelada removida!');
      };

      const startEditCreditPurchase = (purchase) => {
        setEditingCreditPurchase(purchase);
        setFormCreditPurchase({
          title: purchase.title,
          totalAmount: formatNumberForInput(purchase.totalAmount),
          installmentCount: purchase.installmentCount,
          firstDueMonth: purchase.firstDueMonth,
          cardId: String(purchase.cardId),
          category: purchase.category || 'cartao'
        });
        setShowAddCreditPurchase(true);
      };

      const updateCreditPurchase = () => {
        if (!editingCreditPurchase) return;
        
        if (!formCreditPurchase.title.trim()) { notify('Informe a descri√ß√£o', 'error'); return; }
        const calculatedAmount = parseCurrencyInput(formCreditPurchase.totalAmount);
        if (calculatedAmount === '' || isNaN(Number(calculatedAmount)) || Number(calculatedAmount) <= 0) { notify('Valor inv√°lido', 'error'); return; }
        if (!formCreditPurchase.cardId) { notify('Selecione um cart√£o', 'error'); return; }
        
        const cardId = Number(formCreditPurchase.cardId);
        const card = creditCards.find(c => c.id === cardId);
        if (!card) { notify('Cart√£o n√£o encontrado', 'error'); return; }
        
        const totalAmount = Number(calculatedAmount);
        const installmentCount = Number(formCreditPurchase.installmentCount);
        
        // Remove apenas os pagamentos futuros desta compra
        setPayments(prev => prev.filter(p => {
          if (p.creditPurchaseId !== editingCreditPurchase.id) return true;
          // Mant√©m apenas pagamentos de meses passados
          const paymentMonthKey = monthKeyFromIso(p.dueDateIso);
          const currentDate = new Date();
          const currentMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
          return paymentMonthKey < currentMonthKey;
        }));
        
        const installments = generateInstallments({ 
          totalAmount, 
          installmentCount, 
          firstDueMonth: formCreditPurchase.firstDueMonth 
        }, card);
        
        setCreditCardPurchases(prev => prev.map(p => 
          p.id === editingCreditPurchase.id 
            ? { 
                ...p, 
                title: formCreditPurchase.title.trim(),
                totalAmount,
                installmentCount,
                firstDueMonth: formCreditPurchase.firstDueMonth,
                cardId,
                category: formCreditPurchase.category,
                installments,
                updatedAt: new Date().toISOString()
              } 
            : p
        ));
        
        const newPayments = [];
        installments.forEach((inst, index) => {
          const [year, month] = inst.monthKey.split('-').map(Number);
          const dueDate = new Date(year, month - 1, Math.min(card.dueDay, daysInMonth(year, month - 1)), 12, 0, 0);
          newPayments.push({ 
            id: Date.now() + Math.random(), 
            title: `${formCreditPurchase.title.trim()} (${index + 1}/${installmentCount}) - ${card.name}`, 
            amount: inst.amount, 
            dueDateIso: dueDate.toISOString(), 
            paid: inst.paid, 
            notes: `Compra parcelada no ${card.name} (criada em ${formatMonthKey(selectedMonthKey)})`, 
            category: formCreditPurchase.category, 
            creditCardId: cardId, 
            creditPurchaseId: editingCreditPurchase.id, 
            installmentNumber: index + 1,
            createdAt: new Date().toISOString()
          });
        });
        
        setPayments(prev => [...prev, ...newPayments]);
        setFormCreditPurchase({ title: '', totalAmount: '', installmentCount: '', firstDueMonth: selectedMonthKey, cardId: '', category: 'cartao' });
        setEditingCreditPurchase(null);
        setShowAddCreditPurchase(false);
        notify('Compra atualizada! (apenas parcelas futuras)');
      };

      // FUN√á√ÉO ATUALIZADA: Adiciona compra parcelada apenas com parcelas futuras
      const addCreditPurchase = () => {
        if (!formCreditPurchase.title.trim()) { notify('Informe a descri√ß√£o', 'error'); return; }
        const calculatedAmount = parseCurrencyInput(formCreditPurchase.totalAmount);
        if (calculatedAmount === '' || isNaN(Number(calculatedAmount)) || Number(calculatedAmount) <= 0) { notify('Valor inv√°lido', 'error'); return; }
        if (!formCreditPurchase.cardId) { notify('Selecione um cart√£o', 'error'); return; }
        
        const cardId = Number(formCreditPurchase.cardId);
        const card = creditCards.find(c => c.id === cardId);
        if (!card) { notify('Cart√£o n√£o encontrado', 'error'); return; }
        
        const totalAmount = Number(calculatedAmount);
        const installmentCount = Number(formCreditPurchase.installmentCount);
        
        // Usando a fun√ß√£o atualizada de gera√ß√£o de parcelas
        const installments = generateInstallments({ 
          totalAmount, 
          installmentCount, 
          firstDueMonth: formCreditPurchase.firstDueMonth 
        }, card);
        
        const newPurchase = { 
          id: Date.now() + Math.floor(Math.random() * 1000), 
          cardId: cardId, 
          title: formCreditPurchase.title.trim(), 
          totalAmount, 
          installmentCount, 
          firstDueMonth: formCreditPurchase.firstDueMonth, 
          category: formCreditPurchase.category, 
          installments, 
          createdAt: new Date().toISOString(),
          createdInMonth: selectedMonthKey // Marca em que m√™s foi criada
        };
        
        setCreditCardPurchases(prev => [...prev, newPurchase]);
        
        // Criando os pagamentos apenas para as parcelas futuras
        const newPayments = [];
        installments.forEach((inst, index) => {
          const [year, month] = inst.monthKey.split('-').map(Number);
          const dueDate = new Date(year, month - 1, Math.min(card.dueDay, daysInMonth(year, month - 1)), 12, 0, 0);
          newPayments.push({ 
            id: Date.now() + Math.random(), 
            title: `${formCreditPurchase.title.trim()} (${index + 1}/${installmentCount}) - ${card.name}`, 
            amount: inst.amount, 
            dueDateIso: dueDate.toISOString(), 
            paid: false, 
            notes: `Compra parcelada no ${card.name} (criada em ${formatMonthKey(selectedMonthKey)})`, 
            category: formCreditPurchase.category, 
            creditCardId: cardId, 
            creditPurchaseId: newPurchase.id, 
            installmentNumber: index + 1,
            createdAt: new Date().toISOString()
          });
        });
        
        setPayments(prev => [...prev, ...newPayments]);
        setFormCreditPurchase({ title: '', totalAmount: '', installmentCount: '', firstDueMonth: selectedMonthKey, cardId: '', category: 'cartao' });
        setShowAddCreditPurchase(false);
        notify('Compra adicionada! (apenas parcelas futuras)');
      };

      const getCardTotals = () => {
        const totals = {};
        const currentMonthPayments = getFilteredPaymentsForMonth(selectedMonthKey);
        creditCards.forEach(card => {
          const cardPayments = currentMonthPayments.filter(p => p.creditCardId === card.id && !p.paid);
          const currentMonthTotal = cardPayments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          
          // S√≥ considera pagamentos futuros (n√£o do passado)
          const futurePayments = payments.filter(p => 
            p.creditCardId === card.id && 
            !p.paid && 
            monthKeyFromIso(p.dueDateIso) !== selectedMonthKey && 
            new Date(p.dueDateIso) > monthFromKey(selectedMonthKey)
          );
          const futureTotal = futurePayments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          
          const cardPurchases = creditCardPurchases.filter(p => p.cardId === card.id);
          
          let totalActiveDebt = 0;
          
          cardPurchases.forEach(purchase => {
              const paidCount = purchase.installments.filter(inst => inst.paid).length;
              const remainingAmount = purchase.installments.reduce((sum, inst) => sum + (inst.paid ? 0 : inst.amount), 0);
              totalActiveDebt += remainingAmount;
          });
          
          totals[card.id] = { 
              currentMonth: currentMonthTotal, 
              future: futureTotal, 
              allPurchases: cardPurchases,
              totalActiveDebt
          };
        });
        return totals;
      };

      const payCreditCardBill = (cardId) => {
        const card = creditCards.find(c => c.id === cardId);
        if (!card) return;
        
        setPayments(prev => prev.map(p => {
          if (p.creditCardId === cardId && monthKeyFromIso(p.dueDateIso) === selectedMonthKey && !p.paid) {
            return { ...p, paid: true, paidAtIso: new Date().toISOString() };
          }
          return p;
        }));
        
        setCreditCardPurchases(prev => prev.map(purchase => {
          if (purchase.cardId === cardId) {
            const updatedInstallments = purchase.installments.map(inst => {
              if (inst.monthKey === selectedMonthKey) return { ...inst, paid: true };
              return inst;
            });
            return { ...purchase, installments: updatedInstallments };
          }
          return purchase;
        }));
        notify(`Fatura do ${card.name} paga!`);
      };

      const groupPaymentsByCard = (paymentsList) => {
        const cardGroups = {};
        const nonCardPayments = [];
        paymentsList.forEach(payment => {
          if (payment.creditCardId) {
            const cardId = payment.creditCardId;
            const card = creditCards.find(c => c.id === cardId);
            if (card) {
              if (!cardGroups[cardId]) {
                cardGroups[cardId] = { 
                  cardId: cardId, 
                  cardName: card.name, 
                  dueDay: card.dueDay, 
                  color: card.color,
                  total: 0, 
                  payments: [], 
                  allPaid: true 
                };
              }
              cardGroups[cardId].total += Number(payment.amount || 0);
              cardGroups[cardId].payments.push(payment);
              if (!payment.paid) cardGroups[cardId].allPaid = false;
            } else {
              nonCardPayments.push(payment);
            }
          } else {
            nonCardPayments.push(payment);
          }
        });
        return { cardGroups: Object.values(cardGroups), nonCardPayments };
      };

      const toggleCardPaid = (cardId, monthKey) => {
        const paymentsToUpdate = payments.filter(p => p.creditCardId === cardId && monthKeyFromIso(p.dueDateIso) === monthKey);
        if (paymentsToUpdate.length === 0) return;
        const allPaid = paymentsToUpdate.every(p => p.paid);
        
        setPayments(prev => prev.map(p => {
          if (p.creditCardId === cardId && monthKeyFromIso(p.dueDateIso) === monthKey) {
            return { ...p, paid: !allPaid, paidAtIso: !allPaid ? new Date().toISOString() : null };
          }
          return p;
        }));
        
        setCreditCardPurchases(prev => prev.map(purchase => {
          if (purchase.cardId === cardId) {
            const updatedInstallments = purchase.installments.map(inst => {
              if (inst.monthKey === monthKey) return { ...inst, paid: !allPaid };
              return inst;
            });
            return { ...purchase, installments: updatedInstallments };
          }
          return purchase;
        }));
        notify(`Fatura ${!allPaid ? 'paga' : 'pendente'}!`);
      };

      const CreditCardsSection = () => {
        const cardTotals = getCardTotals();
        
        const purchasesByCard = {};
        creditCardPurchases.forEach(purchase => {
          const cardId = purchase.cardId;
          if (!purchasesByCard[cardId]) {
            purchasesByCard[cardId] = [];
          }
          purchasesByCard[cardId].push(purchase);
        });
        
        const getPurchaseStats = (purchase) => {
            const paidCount = purchase.installments.filter(inst => inst.paid).length;
            const remainingCount = purchase.installmentCount - paidCount;
            const paidAmount = paidCount * (purchase.totalAmount / purchase.installmentCount);
            const remainingAmount = remainingCount * (purchase.totalAmount / purchase.installmentCount);
            
            // Calcular valor do m√™s atual
            const currentMonthAmount = purchase.installments
              .filter(inst => inst.monthKey === selectedMonthKey)
              .reduce((sum, inst) => sum + (inst.paid ? 0 : inst.amount), 0);
            
            return { 
              paidCount, 
              remainingCount, 
              paidAmount, 
              remainingAmount,
              currentMonthAmount
            };
        };

        return (
          <div className={`p-4 rounded-lg shadow mb-6 transition-colors duration-200 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-3 sm:space-y-0">
              <h2 className="text-xl font-bold flex items-center space-x-2"><CreditCardIcon /> <span>Cart√µes de Cr√©dito</span></h2>
              <div className="flex flex-wrap gap-2">
                <button onClick={() => setShowAddCreditCard(true)} className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 ${darkMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white touch-target`}>
                  <Plus /> <span className="mobile-hidden sm:inline">Cart√£o</span>
                </button>
                <button onClick={() => { setShowAddCreditPurchase(true); setEditingCreditPurchase(null); }} className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white touch-target`}>
                  <Plus /> <span className="mobile-hidden sm:inline">Compra</span>
                </button>
                <button onClick={() => setShowCreditCards(false)} className={`px-4 py-2 rounded-lg font-medium transition-colors ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-200 hover:bg-gray-300'} touch-target`}>Voltar</button>
              </div>
            </div>
            
            <div className="mb-8">
                <div className="flex items-center justify-between mb-4 p-3 rounded-t-lg bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                    <div className="flex items-center">
                        <h3 className="text-base sm:text-lg font-semibold">Resumo dos Cart√µes (M√™s Atual)</h3>
                        <button 
                            onClick={() => toggleSection('creditCardsSummary')} 
                            className="ml-2 text-white"
                        >
                            {sectionVisibility.creditCardsSummary ? '‚ñº' : '‚ñ∫'}
                        </button>
                    </div>
                    <span className="text-xs sm:text-sm font-medium">
                        {creditCards.filter(card => card.active).length} cart√µes
                    </span>
                </div>
                
                {sectionVisibility.creditCardsSummary && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {creditCards.filter(card => card.active).map(card => {
                            const totals = cardTotals[card.id] || { currentMonth: 0, future: 0, totalActiveDebt: 0 };
                            const textColorClass = getTextColorClass(card.color);
                            
                            return (
                                <div 
                                    key={card.id} 
                                    className={`rounded-lg border transition-colors duration-200 overflow-hidden ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}
                                    style={{ 
                                        borderLeftColor: card.color, 
                                        borderLeftWidth: '6px',
                                        backgroundColor: getLightColor(card.color)
                                    }}
                                >
                                    <div className="p-4">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <div className="flex items-center space-x-2 mb-1">
                                                    <div className="card-color-dot" style={{ backgroundColor: card.color }}></div>
                                                    <h3 className="font-bold text-base sm:text-lg text-gray-800 dark:text-gray-200">{card.name}</h3>
                                                </div>
                                                <p className="text-sm text-gray-800 dark:text-gray-200">Vence dia {card.dueDay}</p>
                                            </div>
                                            <div className="flex space-x-1 sm:space-x-2">
                                                <button onClick={() => payCreditCardBill(card.id)} className={`px-2 sm:px-3 py-1 rounded text-xs font-medium ${totals.currentMonth > 0 ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300'} text-white touch-target`} disabled={totals.currentMonth === 0}>Pagar</button>
                                                <button onClick={() => { setEditingCreditCard(card); setFormCreditCard({ name: card.name, dueDay: String(card.dueDay), color: card.color }); setShowAddCreditCard(true); }} className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'} touch-target`}>‚úèÔ∏è</button>
                                                <button onClick={() => deleteCreditCard(card.id)} className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'} touch-target`}>üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        <div className="space-y-2 text-gray-800 dark:text-gray-200">
                                            <div className="flex justify-between text-sm-responsive">
                                                <span className="opacity-90">Fatura ({formatMonthKey(selectedMonthKey)}):</span>
                                                <span className={`font-bold ${totals.currentMonth > 0 ? 'text-red-500' : 'text-green-500'}`}>{currencyFormat(totals.currentMonth)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm-responsive">
                                                <span className="opacity-90">D√≠vida Futura:</span>
                                                <span className="font-medium text-amber-500">{currencyFormat(totals.future)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm-responsive">
                                                <span className="opacity-90">Total Pendente:</span>
                                                <span className="font-bold text-red-600 dark:text-red-400">{currencyFormat(totals.totalActiveDebt)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
            
            <div>
                <div className="flex items-center justify-between mb-4 p-3 rounded-t-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white">
                    <div className="flex items-center">
                        <h3 className="text-base sm:text-lg font-semibold">üõí Compras Parceladas por Cart√£o</h3>
                        <button 
                            onClick={() => toggleSection('creditCardsPurchases')} 
                            className="ml-2 text-white"
                        >
                            {sectionVisibility.creditCardsPurchases ? '‚ñº' : '‚ñ∫'}
                        </button>
                    </div>
                    <span className="text-xs sm:text-sm font-medium">
                        {creditCardPurchases.filter(p => p.installments.some(inst => !inst.paid)).length} compras ativas
                    </span>
                </div>
                
                {sectionVisibility.creditCardsPurchases && (
                    <div className="space-y-6">
                        {creditCards.filter(card => card.active).map(card => {
                            const cardPurchases = purchasesByCard[card.id] || [];
                            const activeCardPurchases = cardPurchases.filter(p => p.installments.some(inst => !inst.paid));
                            
                            if (activeCardPurchases.length === 0) return null;
                            
                            const isExpanded = expandedCardGroups[card.id] !== false;
                            
                            return (
                                <div key={card.id} className={`rounded-lg border overflow-hidden ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <div 
                                        className="p-4 flex justify-between items-center cursor-pointer hover:opacity-90 transition-opacity touch-target"
                                        style={{ 
                                            backgroundColor: `${card.color}20`,
                                            borderLeft: `6px solid ${card.color}`
                                        }}
                                        onClick={() => toggleCardGroup(card.id)}
                                    >
                                        <div className="flex items-center space-x-3">
                                            <div className="card-color-dot" style={{ backgroundColor: card.color }}></div>
                                            <div className="flex items-center">
                                                <button className="mr-2 text-sm">
                                                    {isExpanded ? '‚ñº' : '‚ñ∫'}
                                                </button>
                                                <div>
                                                    <h4 className="font-bold text-base sm:text-lg text-gray-800 dark:text-gray-200">{card.name}</h4>
                                                    <p className="text-xs sm:text-sm text-gray-800 dark:text-gray-200">{activeCardPurchases.length} compra(s) ativa(s)</p>
                                                    {/* Indicador de compras deste m√™s */}
                                                    <div className="text-xs text-gray-800 dark:text-gray-200 opacity-80">
                                                        Criadas este m√™s: {
                                                            activeCardPurchases.filter(p => p.createdInMonth === selectedMonthKey).length
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xs sm:text-sm text-gray-800 dark:text-gray-200 opacity-80">Total Pendente</div>
                                            <div className="font-bold text-red-500 text-sm-responsive">
                                                {currencyFormat(
                                                    activeCardPurchases.reduce((total, purchase) => {
                                                        const remainingAmount = purchase.installments
                                                            .filter(inst => !inst.paid)
                                                            .reduce((sum, inst) => sum + inst.amount, 0);
                                                        return total + remainingAmount;
                                                    }, 0)
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {isExpanded && (
                                        <div className="divide-y divide-gray-200 dark:divide-gray-700">
                                            {activeCardPurchases.map(purchase => {
                                                const { paidCount, remainingCount, paidAmount, remainingAmount, currentMonthAmount } = getPurchaseStats(purchase);
                                                const cardColor = card.color;
                                                const lightColor = getLightColor(cardColor);
                                                
                                                return (
                                                    <div 
                                                        key={purchase.id} 
                                                        className={`flex flex-col md:flex-row justify-between items-start md:items-center transition-colors duration-200 ${darkMode ? 'hover:bg-gray-700/30' : 'hover:bg-gray-50'} p-4`}
                                                        style={{ backgroundColor: lightColor }}
                                                    >
                                                        <div className="flex-1 min-w-0 mb-2 md:mb-0">
                                                            <div className="flex items-center space-x-2 mb-1">
                                                                <div className="font-bold truncate text-gray-800 dark:text-gray-200 text-sm-responsive">{purchase.title}</div>
                                                                {/* Indicador de data de cria√ß√£o */}
                                                                <span className="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full hidden sm:inline">
                                                                    Criada: {purchase.createdAt ? formatDateDisplay(purchase.createdAt) : formatMonthKey(purchase.createdInMonth || selectedMonthKey)}
                                                                </span>
                                                            </div>
                                                            <div className="text-xs sm:text-sm text-gray-800 dark:text-gray-200 space-x-2">
                                                                <span>{paidCount}/{purchase.installmentCount} parcelas</span>
                                                                <span>|</span>
                                                                <span>In√≠cio: {formatMonthKey(purchase.firstDueMonth)}</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                                                            {/* Valor do m√™s atual */}
                                                            <div className="text-right w-full md:w-auto">
                                                                <div className="text-xs text-gray-800 dark:text-gray-200 opacity-80">Este M√™s</div>
                                                                <div className="font-bold text-blue-500 text-sm-responsive">{currencyFormat(currentMonthAmount)}</div>
                                                            </div>
                                                            <div className="text-right w-full md:w-auto">
                                                                <div className="text-xs text-gray-800 dark:text-gray-200 opacity-80">Falta Pagar</div>
                                                                <div className="font-bold text-red-500 text-sm-responsive">{currencyFormat(remainingAmount)}</div>
                                                            </div>
                                                            <div className="text-right w-full md:w-auto">
                                                                <div className="text-xs text-gray-800 dark:text-gray-200 opacity-80">Total Pago</div>
                                                                <div className="font-medium text-green-500 text-sm-responsive">{currencyFormat(paidAmount)}</div>
                                                            </div>
                                                            <div className="flex space-x-2 w-full md:w-auto justify-end md:justify-start">
                                                                <button 
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        startEditCreditPurchase(purchase);
                                                                    }} 
                                                                    className={`p-1 rounded text-blue-500 hover:text-blue-700 ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} touch-target`} 
                                                                    title="Editar Compra"
                                                                >
                                                                    ‚úèÔ∏è
                                                                </button>
                                                                <button 
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        deleteCreditPurchase(purchase.id);
                                                                    }} 
                                                                    className={`p-1 rounded text-red-500 hover:text-red-700 ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} touch-target`} 
                                                                    title="Remover Compra"
                                                                >
                                                                    <XIcon />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        
                        {creditCards.filter(card => card.active).every(card => {
                            const cardPurchases = purchasesByCard[card.id] || [];
                            return cardPurchases.filter(p => p.installments.some(inst => !inst.paid)).length === 0;
                        }) && (
                            <p className="text-gray-500 dark:text-gray-400 text-center py-4">
                                Nenhuma compra parcelada ativa em nenhum cart√£o.
                            </p>
                        )}
                    </div>
                )}
            </div>
          </div>
        );
      };

      const clearAllData = () => {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Apagar TODOS os dados?')) return;
        if (prompt('Digite "APAGAR" para confirmar:') !== 'APAGAR') return;
        setPayments([]); setTemplatesFixed([]); setEntries([]); setReservations([]); setInstallments([]); setAccounts([]); setCategoryGoals({}); setCategoryBudgets({}); setCreditCards([]); setCreditCardPurchases([]); setAppPassword(null);
        localStorage.clear();
        notify('Dados e senha apagados!', 'success');
      };

      const addAccount = () => {
        if (!formAccount.name.trim()) { notify('Informe o nome','error'); return; }
        const calculatedBalance = parseCurrencyInput(formAccount.balance);
        if (calculatedBalance === '' || isNaN(Number(calculatedBalance))) { notify('Valor inv√°lido','error'); return; }
        const newAccount = { id: Date.now() + Math.random(), name: formAccount.name.trim(), monthlyBalances: { [selectedMonthKey]: Number(calculatedBalance) } };
        setAccounts(prev => [...prev, newAccount]);
        setFormAccount({ name:'', balance:'' });
        setShowAddAccount(false);
        notify('Conta adicionada.');
      };

      const startEditAccount = (a) => {
        setEditingAccount(a);
        const currentBalance = a.monthlyBalances && a.monthlyBalances[selectedMonthKey] !== undefined ? a.monthlyBalances[selectedMonthKey] : '';
        setFormAccount({ name: a.name, balance: formatNumberForInput(currentBalance) });
        setShowAddAccount(true);
      };

      const updateAccount = () => {
        if (!editingAccount) return;
        if (!formAccount.name.trim()) return;
        const calculatedBalance = parseCurrencyInput(formAccount.balance);
        setAccounts(prev => prev.map(x => x.id === editingAccount.id ? { ...x, name: formAccount.name.trim(), monthlyBalances: { ...x.monthlyBalances, [selectedMonthKey]: Number(calculatedBalance) } } : x));
        setEditingAccount(null);
        setFormAccount({ name:'', balance:'' });
        setShowAddAccount(false);
      };

      const deleteAccount = (a) => { if (confirm('Excluir conta?')) setAccounts(prev => prev.filter(x => x.id !== a.id)); };
      const accountsTotal = accounts.reduce((s,a) => s + (a.monthlyBalances && a.monthlyBalances[selectedMonthKey] !== undefined ? Number(a.monthlyBalances[selectedMonthKey]) : 0), 0);

      const viewAccountHistory = (account) => setShowAccountHistory(account);

      const copyBalanceFromPreviousMonth = (account) => {
        const months = getAccountMonths(account);
        if (months.length === 0) return;
        const currentDate = monthFromKey(selectedMonthKey);
        const previousDate = new Date(currentDate);
        previousDate.setMonth(previousDate.getMonth() - 1);
        const previousKey = `${previousDate.getFullYear()}-${String(previousDate.getMonth()+1).padStart(2,'0')}`;
        const previousBalance = account.monthlyBalances[previousKey];
        if (previousBalance === undefined) { notify(`Sem saldo anterior`, 'error'); return; }
        setAccounts(prev => prev.map(a => a.id === account.id ? { ...a, monthlyBalances: { ...a.monthlyBalances, [selectedMonthKey]: previousBalance } } : a));
        notify(`Saldo copiado!`);
      };

      useEffect(() => {
        if (!selectedMonthKey) return;
        const [y, m] = selectedMonthKey.split('-').map(Number);
        const newPayments = [...payments];
        let added = 0;
        templatesFixed.forEach(tpl => {
          const exists = payments.some(p => p.templateId === tpl.id && selectedMonthKey === monthKeyFromIso(p.dueDateIso));
          if (!exists) {
            const day = Math.min(tpl.day, daysInMonth(y, m-1));
            const dueIso = new Date(y, m-1, day, 12,0,0).toISOString();
            newPayments.push({ id: Date.now() + Math.random(), title: tpl.title, amount: tpl.amount, dueDateIso: dueIso, paid: false, notes: tpl.notes || '', category: tpl.category || 'outros', templateId: tpl.id, createdFromTemplateAt: new Date().toISOString(), paidAtIso: false ? new Date().toISOString() : null });
            added++;
          }
        });
        if (added > 0) setPayments(newPayments);
      }, [selectedMonthKey, templatesFixed]);

      // FUN√á√ÉO ATUALIZADA: Filtra pagamentos por m√™s corretamente
      const getFilteredPaymentsForMonth = (monthKey) => {
        return payments.filter(p => {
          const paymentMonthKey = monthKeyFromIso(p.dueDateIso);
          return paymentMonthKey === monthKey;
        });
      };

      const getEntriesForMonth = (monthKey) => entries.filter(e => monthKeyFromIso(e.date) === monthKey);
      const getReservationsForMonth = (monthKey) => reservations;

      const groupByQuinzena = (list) => {
        const first = list.filter(p => new Date(p.dueDateIso).getDate() <= 15);
        const second = list.filter(p => new Date(p.dueDateIso).getDate() >= 16);
        return { first, second };
      };

      const totalsForMonth = (monthKey) => {
        const pays = getFilteredPaymentsForMonth(monthKey);
        const paidSum = pays.filter(p=>p.paid).reduce((s,p)=> s + Number(p.amount||0), 0);
        const pendingSum = pays.filter(p=>!p.paid).reduce((s,p)=> s + Number(p.amount||0), 0);
        const totalSum = pays.reduce((s,p)=> s + Number(p.amount||0), 0);
        const entriesSum = getEntriesForMonth(monthKey).reduce((s,e)=> s + Number(e.amount||0), 0);
        const reservationsSum = getReservationsForMonth(monthKey).reduce((s,r)=> s + Number(r.amount||0), 0);
        const saldo = entriesSum - paidSum;
        return { paidSum, pendingSum, totalSum, entriesSum, reservationsSum, saldo };
      };

      const getCategoryData = () => {
        const pays = getFilteredPaymentsForMonth(selectedMonthKey);
        const categoryTotals = {};
        CATEGORIES.forEach(cat => { categoryTotals[cat.id] = pays.filter(p => p.category === cat.id).reduce((sum, p) => sum + Number(p.amount || 0), 0); });
        return CATEGORIES.map(cat => ({ label: cat.name, value: categoryTotals[cat.id], color: cat.color })).filter(d => d.value > 0);
      };

      const getComparisonData = () => {
        const months = [];
        const currentDate = monthFromKey(selectedMonthKey);
        for (let i = 2; i >= 0; i--) {
          const d = new Date(currentDate);
          d.setMonth(d.getMonth() - i);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          months.push({ key, label: monthNames[d.getMonth()], entries: getEntriesForMonth(key).reduce((s,e)=> s + Number(e.amount||0), 0), expenses: getFilteredPaymentsForMonth(key).reduce((s,p)=> s + Number(p.amount||0), 0) });
        }
        return { labels: months.map(m => m.label), entries: months.map(m => m.entries), expenses: months.map(m => m.expenses) };
      };

      const getFeaturedCategoriesTotal = () => {
        const pays = getFilteredPaymentsForMonth(selectedMonthKey);
        const featured = {};
        CATEGORIES.filter(cat => cat.featured).forEach(cat => {
          featured[cat.id] = { name: cat.name, color: cat.color, bgColor: cat.bgColor, darkBgColor: cat.darkBgColor, total: pays.filter(p => p.category === cat.id).reduce((sum, p) => sum + Number(p.amount || 0), 0) };
        });
        return featured;
      };

      const setBudgetForCategory = (categoryId, amount) => {
        if (amount && Number(amount) > 0) { setCategoryBudgets(prev => ({...prev, [categoryId]: Number(amount)})); }
        else { setCategoryBudgets(prev => { const n = {...prev}; delete n[categoryId]; return n; }); }
      };

      const getCategoryBudgetProgress = () => {
        const pays = getFilteredPaymentsForMonth(selectedMonthKey);
        const progress = {};
        Object.keys(categoryBudgets).forEach(catId => {
          const spent = pays.filter(p => p.category === catId).reduce((sum, p) => sum + Number(p.amount || 0), 0);
          const budget = categoryBudgets[catId];
          const percentage = budget > 0 ? (spent / budget) * 100 : 0;
          const cat = CATEGORIES.find(c => c.id === catId);
          progress[catId] = { name: cat?.name || catId, spent, budget, percentage: Math.min(percentage, 100), overBudget: spent > budget };
        });
        return progress;
      };

      const getDashboardMetrics = () => {
        const current = totalsForMonth(selectedMonthKey);
        const currentDate = monthFromKey(selectedMonthKey);
        const last3Months = [];
        for (let i = 2; i >= 0; i--) {
          const d = new Date(currentDate);
          d.setMonth(d.getMonth() - i);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          last3Months.push(totalsForMonth(key));
        }
        const avgExpenses = last3Months.reduce((sum, m) => sum + m.totalSum, 0) / 3;
        const avgEntries = last3Months.reduce((sum, m) => sum + m.entriesSum, 0) / 3;
        const savings = last3Months.map(m => m.entriesSum - m.paidSum);
        return { currentSaldo: current.entriesSum - current.paidSum, currentSavings: current.entriesSum - current.paidSum, avgExpenses, avgEntries };
      };

      const getQuickStats = () => {
        const pays = getFilteredPaymentsForMonth(selectedMonthKey);
        const mP = pays.filter(p => p.category === 'mercantil' && p.paid);
        const lP = pays.filter(p => p.category === 'lanches' && p.paid);
        const mT = mP.reduce((sum, p) => sum + Number(p.amount || 0), 0);
        const lT = lP.reduce((sum, p) => sum + Number(p.amount || 0), 0);
        return { mercantil: { total: mT, count: mP.length, average: mP.length > 0 ? mT/mP.length : 0 }, lanches: { total: lT, count: lP.length, average: lP.length > 0 ? lT/lP.length : 0 } };
      };

      // CORRE√á√ÉO PRINCIPAL: Gera√ß√£o de lembretes APENAS para o m√™s atual selecionado
      useEffect(() => {
        const check = () => {
          const out = [];
          
          // Obter pagamentos APENAS do m√™s atual selecionado
          const currentMonthPayments = getFilteredPaymentsForMonth(selectedMonthKey);
          
          // Agrupar pagamentos pendentes por cart√£o de cr√©dito (APENAS DO M√äS ATUAL SELECIONADO)
          const paymentsByCard = {};
          
          currentMonthPayments.forEach(p => {
            if (!p.dueDateIso || p.paid) return;
            
            const diffDays = Math.ceil((new Date(p.dueDateIso).setHours(12,0,0,0) - (new Date()).setHours(12,0,0,0)) / (1000*60*60*24));
            
            // Verificar se √© um pagamento do m√™s atual selecionado
            const paymentMonthKey = monthKeyFromIso(p.dueDateIso);
            const currentMonthKey = selectedMonthKey;
            
            // Se o pagamento for do m√™s atual selecionado
            if (p.creditCardId && paymentMonthKey === currentMonthKey) {
              const cardId = p.creditCardId;
              if (!paymentsByCard[cardId]) {
                const card = creditCards.find(c => c.id === cardId);
                paymentsByCard[cardId] = {
                  cardId,
                  cardName: card ? card.name : 'Cart√£o Desconhecido',
                  dueDate: p.dueDateIso,
                  diffDays,
                  totalAmount: 0,
                  payments: []
                };
              }
              paymentsByCard[cardId].totalAmount += Number(p.amount || 0);
              paymentsByCard[cardId].payments.push(p);
              
              // Usar o menor diffDays (mais pr√≥ximo do vencimento)
              if (diffDays < paymentsByCard[cardId].diffDays) {
                paymentsByCard[cardId].diffDays = diffDays;
                paymentsByCard[cardId].dueDate = p.dueDateIso;
              }
            } else if (!p.creditCardId) {
              // Pagamentos n√£o relacionados a cart√£o de cr√©dito
              if (diffDays < 0) out.push({ type: 'overdue', p, days: diffDays });
              else if (diffDays <= alertDaysBefore) out.push({ type: 'upcoming', p, days: diffDays });
            }
          });
          
          // Adicionar alertas consolidados por cart√£o (APENAS DO M√äS SELECIONADO)
          Object.values(paymentsByCard).forEach(cardData => {
            if (cardData.diffDays < 0) {
              out.push({ 
                type: 'overdue', 
                p: { 
                  title: `Fatura ${cardData.cardName}`, 
                  amount: cardData.totalAmount,
                  isCardSummary: true,
                  cardId: cardData.cardId
                }, 
                days: cardData.diffDays 
              });
            } else if (cardData.diffDays <= alertDaysBefore) {
              out.push({ 
                type: 'upcoming', 
                p: { 
                  title: `Fatura ${cardData.cardName}`, 
                  amount: cardData.totalAmount,
                  isCardSummary: true,
                  cardId: cardData.cardId
                }, 
                days: cardData.diffDays 
              });
            }
          });
          
          setReminders(out);
        };
        
        check();
        const t = setInterval(check, 60*1000);
        return () => clearInterval(t);
      }, [selectedMonthKey, alertDaysBefore, creditCards]); // Apenas depend√™ncias relevantes

      const notify = (text, type='success') => { setNotification({ show:true, text, type }); setTimeout(()=> setNotification({ show:false, text:'', type:'success' }), 3500); };

      const addPayment = () => {
        if (!formPayment.title.trim()) { 
          notify('Informe o nome da conta', 'error'); 
          return; 
        }
        
        const calculatedAmount = parseCurrencyInput(formPayment.amount);
        if (calculatedAmount === '' || isNaN(Number(calculatedAmount)) || Number(calculatedAmount) <= 0) { 
          notify('Valor inv√°lido. Ex: 50,00 ou 30+20', 'error'); 
          return; 
        }
        
        const day = Number(formPayment.day);
        if (isNaN(day) || day < 1 || day > 31) {
          notify('Dia inv√°lido (1-31)', 'error');
          return;
        }

        const [y, m] = selectedMonthKey.split('-').map(Number);
        const lastDay = daysInMonth(y, m-1);
        const dueDay = Math.min(day, lastDay);
        const dueIso = new Date(y, m-1, dueDay, 12, 0, 0).toISOString();
        
        if (formPayment.type === 'fixed') {
          const tpl = { 
            id: Date.now() + Math.random(), 
            title: formPayment.title.trim(), 
            amount: Number(calculatedAmount), 
            day: dueDay, 
            notes: formPayment.notes || '', 
            category: formPayment.category || 'outros' 
          };
          
          setTemplatesFixed(prev => [...prev, tpl]);
          setPayments(prev => [...prev, { 
            id: Date.now() + Math.random(), 
            title: tpl.title, 
            amount: tpl.amount, 
            dueDateIso: dueIso, 
            paid: formPayment.paid, 
            notes: tpl.notes || '', 
            category: tpl.category, 
            templateId: tpl.id, 
            createdFromTemplateAt: new Date().toISOString(), 
            paidAtIso: formPayment.paid ? new Date().toISOString() : null 
          }]);
        } else {
          setPayments(prev => [...prev, { 
            id: Date.now() + Math.random(), 
            title: formPayment.title.trim(), 
            amount: Number(calculatedAmount), 
            dueDateIso: dueIso, 
            paid: formPayment.paid, 
            notes: formPayment.notes || '', 
            category: formPayment.category || 'outros', 
            templateId: null, 
            paidAtIso: formPayment.paid ? new Date().toISOString() : null 
          }]);
        }
        
        setFormPayment({ 
          title: '', 
          amount: '', 
          day: '', 
          type: 'variable', 
          notes: '', 
          category: 'outros', 
          paid: false, 
          calculatedResult: '' 
        });
        setShowAddPayment(false);
        notify('Pagamento adicionado com sucesso!');
      };

      const startEditPayment = (p) => {
        setEditingPayment(p);
        const d = new Date(p.dueDateIso);
        setFormPayment({ 
          title: p.title, 
          amount: formatNumberForInput(p.amount), 
          day: String(d.getDate()), 
          type: p.templateId ? 'fixed' : 'variable', 
          notes: p.notes || '', 
          category: p.category || 'outros', 
          paid: p.paid,
          calculatedResult: '' 
        });
        setShowAddPayment(true);
      };

      const updatePayment = () => {
        if (!editingPayment) return;
        const calculatedAmount = parseCurrencyInput(formPayment.amount);
        const [y,m] = selectedMonthKey.split('-').map(Number);
        const newDueIso = new Date(y,m-1,Math.min(Number(formPayment.day), daysInMonth(y,m-1)),12,0,0).toISOString();
        setPayments(prev => prev.map(p => p.id === editingPayment.id ? { ...p, title: formPayment.title.trim(), amount: Number(calculatedAmount), dueDateIso: newDueIso, notes: formPayment.notes || '', category: formPayment.category || 'outros', paid: formPayment.paid, paidAtIso: formPayment.paid && !p.paid ? new Date().toISOString() : p.paidAtIso } : p));
        if (editingPayment.templateId) {
          setTemplatesFixed(prev => prev.map(t => t.id === editingPayment.templateId ? { ...t, title: formPayment.title.trim(), amount: Number(calculatedAmount), day: Number(formPayment.day), notes: formPayment.notes || '', category: formPayment.category || 'outros' } : t));
        }
        setEditingPayment(null); 
        setFormPayment({ title:'', amount:'', day:'', type:'variable', notes:'', category:'outros', paid: false, calculatedResult: '' }); 
        setShowAddPayment(false);
        notify('Pagamento atualizado!');
      };

      const deletePayment = (p) => {
        if (!confirm('Excluir?')) return;
        if (p.templateId && confirm('Apagar modelo fixo tamb√©m?')) {
          setTemplatesFixed(prev => prev.filter(t => t.id !== p.templateId));
          setPayments(prev => prev.filter(x => x.templateId !== p.templateId));
          return;
        }
        setPayments(prev => prev.filter(x => x.id !== p.id));
      };

      const togglePaid = (p) => setPayments(prev => prev.map(x => x.id === p.id ? { ...x, paid: !x.paid, paidAtIso: !x.paid ? new Date().toISOString() : null } : x));

      const addEntry = () => {
        if (!formEntry.name.trim()) return;
        const calculatedAmount = parseCurrencyInput(formEntry.amount);
        setEntries(prev => [...prev, { id: Date.now()+Math.random(), name: formEntry.name.trim(), amount: Number(calculatedAmount), date: isoFromDateInput(formEntry.date), notes: formEntry.notes || '' }]);
        setFormEntry({ name:'', amount:'', date:'', notes:'' }); 
        setShowAddEntry(false);
      };

      const startEditEntry = (e) => { 
        setEditingEntry(e); 
        setFormEntry({ 
          name: e.name, 
          amount: formatNumberForInput(e.amount), 
          date: new Date(e.date).toISOString().slice(0,10), 
          notes: e.notes || '' 
        }); 
        setShowAddEntry(true); 
      };
      
      const updateEntry = () => { 
        if(!editingEntry) return; 
        const c = parseCurrencyInput(formEntry.amount); 
        setEntries(prev => prev.map(x => x.id === editingEntry.id ? {...x, name: formEntry.name.trim(), amount: Number(c), date: isoFromDateInput(formEntry.date), notes: formEntry.notes||''} : x)); 
        setEditingEntry(null); 
        setFormEntry({name:'',amount:'',date:'',notes:''}); 
        setShowAddEntry(false); 
      };
      
      const deleteEntry = (e) => { 
        if(confirm('Excluir?')) setEntries(prev => prev.filter(x => x.id !== e.id)); 
      };

      const addReservation = () => {
        const c = parseCurrencyInput(formReservation.amount);
        setReservations(prev => [...prev, { id: Date.now()+Math.random(), name: formReservation.name.trim(), amount: Number(c), date: isoFromDateInput(formReservation.date), notes: formReservation.notes || '' }]);
        setFormReservation({ name:'', amount:'', date:'', notes:'' }); 
        setShowAddReservation(false);
      };
      
      const startEditReservation = (r) => { 
        setEditingReservation(r); 
        setFormReservation({ 
          name: r.name, 
          amount: formatNumberForInput(r.amount), 
          date: new Date(r.date).toISOString().slice(0,10), 
          notes: r.notes || '' 
        }); 
        setShowAddReservation(true); 
      };
      
      const updateReservation = () => { 
        if(!editingReservation) return; 
        const c = parseCurrencyInput(formReservation.amount); 
        setReservations(prev => prev.map(x => x.id === editingReservation.id ? {...x, name: formReservation.name.trim(), amount: Number(c), date: isoFromDateInput(formReservation.date), notes: formReservation.notes||''} : x)); 
        setEditingReservation(null); 
        setFormReservation({name:'',amount:'',date:'',notes:''}); 
        setShowAddReservation(false); 
      };
      
      const deleteReservation = (r) => { 
        if(confirm('Excluir?')) setReservations(prev => prev.filter(x => x.id !== r.id)); 
      };

      const addInstallment = () => {
        const total = parseCurrencyInput(formInstallment.totalAmount);
        const count = Number(formInstallment.installmentCount);
        if (total === '' || isNaN(Number(total)) || Number(total) <= 0) {
          notify('Valor total inv√°lido', 'error');
          return;
        }
        if (count <= 0 || count > 60) {
          notify('N√∫mero de parcelas inv√°lido', 'error');
          return;
        }
        
        const amount = Number(total) / count;
        const [y,m] = selectedMonthKey.split('-').map(Number);
        const newI = [];
        for (let i = 0; i < count; i++) {
          newI.push({ 
            id: Date.now() + Math.random(), 
            title: `${formInstallment.title.trim()} (${i+1}/${count})`, 
            amount, 
            dueDateIso: new Date(y, m-1 + i, Math.min(Number(formInstallment.firstDueDay), daysInMonth(y, m-1+i)), 12,0,0).toISOString(), 
            paid: false, 
            notes: formInstallment.notes || '',
            category: formInstallment.category || 'outros', 
            installmentId: Date.now(), 
            installmentIndex: i, 
            totalInstallments: count 
          });
        }
        setInstallments(prev=>[...prev,...newI]); 
        setPayments(prev=>[...prev,...newI]); 
        setFormInstallment({ title:'', totalAmount:'', installmentCount:'', firstDueDay:'', category:'outros', notes:'' }); 
        setShowAddInstallment(false);
        notify('Parcelamento adicionado!');
      };

      const exportData = () => {
        const data = { payments, templatesFixed, entries, reservations, installments, accounts, categoryGoals, categoryBudgets, creditCards, creditCardPurchases };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `financas-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); notify('Backup exportado.');
      };

      const importData = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (data.payments) setPayments(data.payments);
            if (data.templatesFixed) setTemplatesFixed(data.templatesFixed);
            if (data.entries) setEntries(data.entries);
            if (data.reservations) setReservations(data.reservations);
            if (data.installments) setInstallments(data.installments);
            if (data.accounts) setAccounts(data.accounts);
            if (data.categoryGoals) setCategoryGoals(data.categoryGoals);
            if (data.categoryBudgets) setCategoryBudgets(data.categoryBudgets);
            if (data.creditCards) setCreditCards(data.creditCards);
            if (data.creditCardPurchases) setCreditCardPurchases(data.creditCardPurchases);
            notify('Dados importados.');
          } catch (err) { notify('Erro ao importar.','error'); }
        };
        reader.readAsText(file); e.target.value = '';
      };

      const changeMonth = (dir) => {
        const [y, m] = selectedMonthKey.split('-').map(Number);
        const d = new Date(y, m-1 + dir, 1);
        setSelectedMonthKey(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
      };

      // FUN√á√ÉO ATUALIZADA: Usa getFilteredPaymentsForMonth
      const filteredPayments = () => {
        let pays = getFilteredPaymentsForMonth(selectedMonthKey);
        
        if (search.trim()) {
          pays = pays.filter(p => 
            p.title.toLowerCase().includes(search.toLowerCase()) || 
            (p.notes && p.notes.toLowerCase().includes(search.toLowerCase()))
          );
        }
        
        if (categoryFilter !== 'all') {
          pays = pays.filter(p => p.category === categoryFilter);
        }
        
        return pays;
      };

      const getSectionColors = (section) => darkMode ? SECTION_COLORS[section].dark : SECTION_COLORS[section].light;
      const featuredTotals = getFeaturedCategoriesTotal();
      const categoryData = getCategoryData();
      const comparisonData = getComparisonData();
      const budgetProgress = getCategoryBudgetProgress();
      const dashboardMetrics = getDashboardMetrics();
      const totals = totalsForMonth(selectedMonthKey);
      const quickStats = getQuickStats();
      
      if (!isAuthenticated) {
        return <LoginScreen onLogin={handleLogin} darkMode={darkMode} hasPassword={!!appPassword} />;
      }

      return (
        <div className={`min-h-screen transition-colors duration-200 ${darkMode ? 'dark bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'}`}>
          {/* Header responsivo */}
          <header className={`sticky top-0 z-20 shadow-sm transition-colors duration-200 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <div className="max-w-7xl mx-auto px-3 sm:px-4 py-3">
              {/* Primeira linha: t√≠tulo e menu mobile */}
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center space-x-3">
                  <button 
                    onClick={() => setShowMobileMenu(!showMobileMenu)}
                    className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} md:hidden`}
                  >
                    {showMobileMenu ? <CloseIcon /> : <MenuIcon />}
                  </button>
                  <h1 className="text-xl font-bold">üí∞ Finan√ßas</h1>
                </div>
                
                <div className="flex items-center space-x-2">
                  {/* Bot√£o para alternar cart√µes */}
                  <button onClick={() => setShowCreditCards(!showCreditCards)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`} title="Cart√µes"><CreditCardIcon /></button>
                  
                  {/* Bot√£o tema escuro/claro */}
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}>{darkMode ? <Sun /> : <Moon />}</button>
                </div>
              </div>
              
              {/* Segunda linha: navega√ß√£o do m√™s */}
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                  <button onClick={() => changeMonth(-1)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><Left /></button>
                  <span className="text-lg font-semibold min-w-[120px] text-center">{new Date(monthFromKey(selectedMonthKey)).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</span>
                  <button onClick={() => changeMonth(1)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><Right /></button>
                </div>
                
                {/* Menu desktop (escondido no mobile) */}
                <div className="hidden md:flex items-center space-x-2">
                  {/* NOVO BOT√ÉO PARA GERAR PDF */}
                  <button 
                    onClick={() => setShowPDFConfig(true)} 
                    className={`p-2 rounded-lg transition-colors flex items-center justify-center ${darkMode ? 'hover:bg-gray-700 text-red-400' : 'hover:bg-gray-100 text-red-500'} touch-target`}
                    title="Gerar Relat√≥rio PDF"
                  >
                    <PDFIcon />
                  </button>
                  
                  <button 
                    onClick={() => setShowPasswordModal(true)} 
                    className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700 text-yellow-400' : 'hover:bg-gray-100 text-yellow-600'} touch-target`}
                    title="Configurar Senha"
                  >
                    {appPassword ? <Lock /> : <Unlock />}
                  </button>

                  <button onClick={() => setShowDashboard(!showDashboard)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><DashboardIcon /></button>
                  <button onClick={() => setShowAnalytics(!showAnalytics)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><ChartIcon /></button>
                  <button onClick={exportData} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><Download /></button>
                  <label className={`p-2 rounded-lg cursor-pointer transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}><Upload /><input type="file" accept=".json" onChange={importData} className="hidden" /></label>
                  <button onClick={clearAllData} className={`p-2 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700 text-red-400' : 'hover:bg-gray-100 text-red-500'} touch-target`} title="Apagar tudo">üóëÔ∏è</button>
                </div>
              </div>
            </div>
            
            {/* Menu mobile expandido */}
            {showMobileMenu && (
              <div className={`md:hidden border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <div className="grid grid-cols-4 gap-1 p-3">
                  <button 
                    onClick={() => { setShowPDFConfig(true); setShowMobileMenu(false); }} 
                    className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}
                    title="Gerar PDF"
                  >
                    <PDFIcon className="w-5 h-5 mb-1" />
                    <span className="text-xs">PDF</span>
                  </button>
                  
                  <button 
                    onClick={() => { setShowPasswordModal(true); setShowMobileMenu(false); }} 
                    className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}
                    title="Senha"
                  >
                    {appPassword ? <Lock className="w-5 h-5 mb-1" /> : <Unlock className="w-5 h-5 mb-1" />}
                    <span className="text-xs">Senha</span>
                  </button>
                  
                  <button onClick={() => { setShowDashboard(!showDashboard); setShowMobileMenu(false); }} className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}>
                    <DashboardIcon className="w-5 h-5 mb-1" />
                    <span className="text-xs">Dashboard</span>
                  </button>
                  
                  <button onClick={() => { setShowAnalytics(!showAnalytics); setShowMobileMenu(false); }} className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}>
                    <ChartIcon className="w-5 h-5 mb-1" />
                    <span className="text-xs">An√°lises</span>
                  </button>
                  
                  <button onClick={() => { exportData(); setShowMobileMenu(false); }} className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}>
                    <Download className="w-5 h-5 mb-1" />
                    <span className="text-xs">Exportar</span>
                  </button>
                  
                  <label className={`flex flex-col items-center justify-center p-3 rounded-lg cursor-pointer transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} touch-target`}>
                    <Upload className="w-5 h-5 mb-1" />
                    <span className="text-xs">Importar</span>
                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                  </label>
                  
                  <button onClick={() => { clearAllData(); setShowMobileMenu(false); }} className={`flex flex-col items-center justify-center p-3 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700 text-red-400' : 'hover:bg-gray-100 text-red-500'} touch-target`}>
                    <span className="text-lg mb-1">üóëÔ∏è</span>
                    <span className="text-xs">Limpar</span>
                  </button>
                </div>
              </div>
            )}
          </header>

          {showCreditCards && <CreditCardsSection />}

          {!showCreditCards && (
            <main className="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
              {showDashboard && (
                <div className={`max-w-7xl mx-auto p-4 mb-4 rounded-lg shadow transition-colors duration-200 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-3 sm:space-y-0">
                    <h2 className="text-xl font-bold">üìä Dashboard</h2>
                    <button onClick={() => setShowBudgetManager(!showBudgetManager)} className={`px-4 py-2 rounded-lg font-medium transition-colors ${darkMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white touch-target`}>{showBudgetManager ? 'Voltar' : 'Or√ßamentos'}</button>
                  </div>
                  {showBudgetManager ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {CATEGORIES.map(cat => (
                        <div key={cat.id} className={`p-4 rounded-lg border transition-colors duration-200 ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                          <div className="flex items-center justify-between mb-3"><span className="font-medium text-sm-responsive">{cat.name}</span><span style={{ color: cat.color }}>‚óè</span></div>
                          <input type="number" placeholder="Or√ßamento mensal" value={categoryBudgets[cat.id] || ''} onChange={(e) => setBudgetForCategory(cat.id, e.target.value)} className={`w-full px-3 py-2 rounded border transition-colors duration-200 text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`} />
                        </div>
                      ))}
                    </div>
                  ) : (
                    <>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}`}><div className="text-sm opacity-70">Saldo Atual</div><div className={`text-lg sm:text-xl font-bold ${dashboardMetrics.currentSaldo >= 0 ? 'text-green-500' : 'text-red-500'}`}>{currencyFormat(dashboardMetrics.currentSaldo)}</div></div>
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}`}><div className="text-sm opacity-70">Economia M√™s</div><div className={`text-lg sm:text-xl font-bold ${dashboardMetrics.currentSavings >= 0 ? 'text-green-500' : 'text-red-500'}`}>{currencyFormat(dashboardMetrics.currentSavings)}</div></div>
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}`}><div className="text-sm opacity-70">M√©dia Despesas</div><div className="text-lg sm:text-xl font-bold text-orange-500">{currencyFormat(dashboardMetrics.avgExpenses)}</div></div>
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}`}><div className="text-sm opacity-70">M√©dia Entradas</div><div className="text-lg sm:text-xl font-bold text-blue-500">{currencyFormat(dashboardMetrics.avgEntries)}</div></div>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-6">
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-emerald-700 bg-emerald-900/20' : 'border-emerald-200 bg-emerald-50'}`}><h3 className="font-semibold text-emerald-800 dark:text-emerald-200 mb-3 text-sm-responsive">üõí Mercantil (Este M√™s)</h3><div className="flex justify-between font-bold text-emerald-600 dark:text-emerald-400"><span>Total:</span><span>{currencyFormat(quickStats.mercantil.total)}</span></div></div>
                        <div className={`p-4 rounded-lg border ${darkMode ? 'border-amber-700 bg-amber-900/20' : 'border-amber-200 bg-amber-50'}`}><h3 className="font-semibold text-amber-800 dark:text-amber-200 mb-3 text-sm-responsive">üçï Lanches (Este M√™s)</h3><div className="flex justify-between font-bold text-amber-600 dark:text-amber-400"><span>Total:</span><span>{currencyFormat(quickStats.lanches.total)}</span></div></div>
                      </div>
                    </>
                  )}
                </div>
              )}

              {showAnalytics && (
                <div className={`max-w-7xl mx-auto p-4 mb-4 rounded-lg shadow transition-colors duration-200 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <h2 className="text-xl font-bold mb-4">üìà An√°lises</h2>
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                      <div className="h-64">
                        <PieChart data={categoryData} title="Despesas por Categoria" />
                      </div>
                    </div>
                    <div className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                      <div className="h-64">
                        <BarChart data={comparisonData} title="Comparativo Mensal" />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* CORRE√á√ÉO: Renderiza√ß√£o dos lembretes apenas para o m√™s atual */}
              {reminders.length > 0 && (
                <div className="mb-6 space-y-2">
                  {reminders.map((rem, idx) => (
                    <div key={idx} className={`p-4 rounded-lg border ${rem.type === 'overdue' ? 'border-red-200 bg-red-50 dark:border-red-800 dark:bg-red-900/20' : 'border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-900/20'}`}>
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div className="mb-2 sm:mb-0">
                          <span className="font-medium text-sm-responsive">{rem.p.title}</span>
                          <span className="text-sm ml-2 block sm:inline">
                            {rem.type === 'overdue' ? `Atrasado ${Math.abs(rem.days)} dia(s)` : `Vence em ${rem.days} dia(s)`}
                          </span>
                          {rem.p.isCardSummary && (
                            <div className="text-xs text-gray-600 dark:text-gray-300 mt-1">
                              Valor total da fatura
                            </div>
                          )}
                        </div>
                        <span className="font-bold text-red-600 dark:text-red-400 text-sm-responsive">
                          {currencyFormat(rem.p.amount)}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Resumo financeiro - Responsivo */}
              <div className="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-4 mb-6">
                <div className={`p-3 sm:p-4 rounded-lg text-center shadow ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="text-xs sm:text-sm opacity-60">Total Despesas</div>
                  <div className="text-base sm:text-xl font-bold text-red-500">{currencyFormat(totals.totalSum)}</div>
                </div>
                <div className={`p-3 sm:p-4 rounded-lg text-center shadow ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="text-xs sm:text-sm opacity-60">Pago</div>
                  <div className="text-base sm:text-xl font-bold text-green-500">{currencyFormat(totals.paidSum)}</div>
                </div>
                <div className={`p-3 sm:p-4 rounded-lg text-center shadow ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="text-xs sm:text-sm opacity-60">Pendente</div>
                  <div className="text-base sm:text-xl font-bold text-yellow-500">{currencyFormat(totals.pendingSum)}</div>
                </div>
                <div className={`p-3 sm:p-4 rounded-lg text-center shadow ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="text-xs sm:text-sm opacity-60">Entradas</div>
                  <div className="text-base sm:text-xl font-bold text-blue-500">{currencyFormat(totals.entriesSum)}</div>
                </div>
                <div className={`p-3 sm:p-4 rounded-lg text-center shadow col-span-2 sm:col-span-1 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className="text-xs sm:text-sm opacity-60">Saldo</div>
                  <div className={`text-base sm:text-xl font-bold ${totals.saldo >= 0 ? 'text-green-500' : 'text-red-500'}`}>{currencyFormat(totals.saldo)}</div>
                </div>
              </div>

              {/* Categorias em destaque - Responsivo */}
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-6">
                {CATEGORIES.filter(cat => cat.featured).map(cat => (
                  <div key={cat.id} className={`p-3 rounded-lg text-white shadow ${darkMode ? cat.darkBgColor : cat.bgColor}`}>
                    <div className="flex justify-between text-xs sm:text-sm font-medium">
                      <span className="truncate">{cat.name}</span>
                      <span>‚óè</span>
                    </div>
                    <div className="text-sm sm:text-lg font-bold mt-1 truncate">{currencyFormat(featuredTotals[cat.id]?.total || 0)}</div>
                  </div>
                ))}
              </div>

              {/* Se√ß√£o de contas banc√°rias */}
              <div className={`p-4 rounded-lg shadow mb-6 transition-colors duration-200 ${getSectionColors('contas').bg} ${getSectionColors('contas').border} border`}>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                  <div className="flex items-center space-x-2">
                    <h2 className={`text-base sm:text-lg font-semibold ${getSectionColors('contas').text}`}>üè¶ Contas</h2>
                    <button onClick={() => toggleSection('accounts')} className="text-sm">{sectionVisibility.accounts ? '‚ñº' : '‚ñ∫'}</button>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${accountsTotal >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{currencyFormat(accountsTotal)}</span>
                </div>
                {sectionVisibility.accounts && (
                  <>
                    <div className="space-y-2">
                      {accounts.map(a => (
                        <div key={a.id} className={`flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded border ${darkMode ? 'border-amber-700 hover:bg-amber-900/20' : 'border-amber-200 hover:bg-amber-100'} mobile-space-y-2`}>
                          <div className="flex items-center space-x-2">
                            <span className="text-sm-responsive">{a.name}</span>
                            <button onClick={() => viewAccountHistory(a)} className="opacity-50 hover:opacity-100 touch-target"><HistoryIcon /></button>
                          </div>
                          <div className="flex items-center space-x-2 w-full sm:w-auto justify-between sm:justify-start">
                            <span className={`font-medium text-sm-responsive ${Number(a.monthlyBalances?.[selectedMonthKey]||0) >= 0 ? 'text-green-500' : 'text-red-500'}`}>{currencyFormat(a.monthlyBalances?.[selectedMonthKey]||0)}</span>
                            <div className="flex space-x-1">
                              <button onClick={() => startEditAccount(a)} className="touch-target">‚úèÔ∏è</button>
                              <button onClick={() => deleteAccount(a)} className="touch-target">üóëÔ∏è</button>
                              <button onClick={() => copyBalanceFromPreviousMonth(a)} className="touch-target" title="Copiar m√™s anterior">üìã</button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button onClick={() => { setShowAddAccount(true); setEditingAccount(null); setFormAccount({ name:'', balance:'' }); }} className={`mt-3 w-full py-2 rounded-lg border-2 border-dashed flex items-center justify-center space-x-2 ${darkMode ? 'border-amber-600 hover:bg-amber-900/20' : 'border-amber-300 hover:bg-amber-100'} touch-target`}><Plus /><span>Adicionar Conta</span></button>
                  </>
                )}
              </div>

              {/* Barra de busca e filtros */}
              <div className={`p-4 rounded-lg shadow mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <div className="flex flex-col space-y-3">
                  <input type="text" placeholder="üîç Buscar..." value={search} onChange={(e) => setSearch(e.target.value)} className={`flex-1 px-4 py-2 rounded-lg border text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`} />
                  <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)} className={`px-4 py-2 rounded-lg border text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}>
                      <option value="all">Todas</option>
                      {CATEGORIES.map(cat => (<option key={cat.id} value={cat.id}>{cat.name}</option>))}
                    </select>
                    <button onClick={() => setShowFixedAccounts(!showFixedAccounts)} className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} touch-target`}>{showFixedAccounts ? 'Ocultar Fixas' : 'Ver Fixas'}</button>
                  </div>
                </div>
              </div>

              {/* Quinzenas - Layout responsivo */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                {['first', 'second'].map((quinzena, idx) => {
                  const pays = groupByQuinzena(filteredPayments())[quinzena];
                  const total = pays.reduce((s,p) => s + Number(p.amount||0), 0);
                  const section = idx === 0 ? 'quinzena1' : 'quinzena2';
                  const colors = getSectionColors(section);
                  return (
                    <div key={quinzena} className={`rounded-lg shadow border ${colors.bg} ${colors.border}`}>
                      <div className={`p-4 rounded-t-lg ${colors.header} text-white flex justify-between items-center`}>
                        <div className="flex items-center space-x-2">
                          <h3 className="font-semibold text-sm-responsive">{idx === 0 ? '1¬™ Quinzena' : '2¬™ Quinzena'}</h3>
                          <button onClick={() => toggleSection(section)}>{sectionVisibility[section] ? '‚ñº' : '‚ñ∫'}</button>
                        </div>
                        <span className="font-bold text-sm-responsive">{currencyFormat(total)}</span>
                      </div>
                      {sectionVisibility[section] && (
                        <div className="p-4 space-y-3">
                          {(() => {
                            const { cardGroups, nonCardPayments } = groupPaymentsByCard(pays);
                            return (
                              <>
                                {cardGroups.map(group => {
                                  const lightColor = getLightColor(group.color);
                                  
                                  return (
                                    <div 
                                      key={group.cardId} 
                                      className={`flex items-center justify-between p-3 rounded border ${darkMode ? 'border-gray-700' : 'border-gray-200'} ${group.allPaid ? 'opacity-60' : ''}`}
                                      style={{ 
                                        backgroundColor: lightColor,
                                        borderLeftColor: group.color,
                                        borderLeftWidth: '4px'
                                      }}
                                    >
                                      <div className="flex items-center space-x-3">
                                        <button onClick={() => toggleCardPaid(group.cardId, selectedMonthKey)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${group.allPaid ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'} touch-target`}>
                                          {group.allPaid && '‚úì'}
                                        </button>
                                        <div>
                                          <div className="flex items-center space-x-2">
                                            <div className="card-color-dot" style={{ backgroundColor: group.color }}></div>
                                            <div className="font-medium text-gray-800 dark:text-gray-200 text-sm-responsive">Fatura {group.cardName}</div>
                                          </div>
                                          <div className="text-xs text-gray-800 dark:text-gray-200">Vence dia {group.dueDay}</div>
                                        </div>
                                      </div>
                                      <span className="font-medium text-gray-800 dark:text-gray-200 text-sm-responsive">{currencyFormat(group.total)}</span>
                                    </div>
                                  );
                                })}
                                {nonCardPayments.map(p => {
                                  const cat = CATEGORIES.find(c => c.id === p.category) || CATEGORIES.find(c => c.id === 'outros');
                                  return (
                                    <div key={p.id} className={`flex items-center justify-between p-3 rounded border ${darkMode ? 'border-gray-700' : 'border-gray-200'} ${p.paid ? 'opacity-60' : ''}`}>
                                      <div className="flex items-center space-x-3">
                                        <button onClick={() => togglePaid(p)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${p.paid ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'} touch-target`}>
                                          {p.paid && '‚úì'}
                                        </button>
                                        <div className="flex-1 min-w-0">
                                          <div className="font-medium truncate text-gray-800 dark:text-gray-200 text-sm-responsive">{p.title}</div>
                                          <div className="text-xs opacity-70 flex items-center space-x-2">
                                            <span className="text-gray-800 dark:text-gray-200">{formatDateDisplay(p.dueDateIso)}</span>
                                            <span style={{ color: cat.color }}>‚óè {cat.name}</span>
                                          </div>
                                          {p.notes && p.notes.trim() !== '' && (
                                            <div className="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                              <span className="font-medium">Obs:</span> {p.notes}
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                      <div className="flex items-center space-x-2">
                                        <span className="font-medium text-gray-800 dark:text-gray-200 text-sm-responsive">{currencyFormat(p.amount)}</span>
                                        <button onClick={() => startEditPayment(p)} className="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded touch-target">‚úèÔ∏è</button>
                                        <button onClick={() => deletePayment(p)} className="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded touch-target">üóëÔ∏è</button>
                                      </div>
                                    </div>
                                  );
                                })}
                              </>
                            );
                          })()}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              {showFixedAccounts && sectionVisibility.fixedAccounts && (
                <div className={`p-4 rounded-lg shadow mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <h2 className="text-lg font-semibold mb-4">üîÑ Contas Fixas</h2>
                  <div className="space-y-3">{templatesFixed.map(tpl => (<div key={tpl.id} className={`flex items-center justify-between p-3 rounded border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}><div><div className="font-medium text-sm-responsive">{tpl.title}</div><div className="text-xs sm:text-sm opacity-70">Dia {tpl.day} ‚Ä¢ {currencyFormat(tpl.amount)}</div></div><button onClick={() => deletePayment({ templateId: tpl.id })} className="touch-target">üóëÔ∏è</button></div>))}</div>
                </div>
              )}

              {/* Se√ß√£o de entradas */}
              <div className={`p-4 rounded-lg shadow mb-6 border ${getSectionColors('entradas').bg} ${getSectionColors('entradas').border}`}>
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center space-x-2">
                    <h2 className={`text-base sm:text-lg font-semibold ${getSectionColors('entradas').text}`}>üí∞ Entradas</h2>
                    <button onClick={() => toggleSection('entries')}>{sectionVisibility.entries ? '‚ñº' : '‚ñ∫'}</button>
                  </div>
                </div>
                {sectionVisibility.entries && (
                  <>
                    <div className="space-y-3">
                      {getEntriesForMonth(selectedMonthKey).map(e => (
                        <div key={e.id} className={`flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded border ${darkMode ? 'border-green-700' : 'border-green-200'} mobile-space-y-2`}>
                          <div>
                            <div className="font-medium text-sm-responsive">{e.name}</div>
                            <div className="text-xs sm:text-sm opacity-70">{formatDateDisplay(e.date)}</div>
                          </div>
                          <div className="flex items-center space-x-2 w-full sm:w-auto justify-between sm:justify-start">
                            <span className="text-green-500 text-sm-responsive">{currencyFormat(e.amount)}</span>
                            <div className="flex space-x-2">
                              <button onClick={() => startEditEntry(e)} className="touch-target">‚úèÔ∏è</button>
                              <button onClick={() => deleteEntry(e)} className="touch-target">üóëÔ∏è</button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button onClick={() => { setShowAddEntry(true); setEditingEntry(null); setFormEntry({ name:'', amount:'', date:'', notes:'' }); }} className={`mt-3 w-full py-2 rounded-lg border-2 border-dashed flex justify-center space-x-2 ${darkMode ? 'border-green-600 hover:bg-green-900/20' : 'border-green-300 hover:bg-green-100'} touch-target`}>
                      <Plus /><span>Adicionar Entrada</span>
                    </button>
                  </>
                )}
              </div>

              {/* Se√ß√£o de reservas */}
              <div className={`p-4 rounded-lg shadow mb-6 border ${getSectionColors('reservas').bg} ${getSectionColors('reservas').border}`}>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                  <div className="flex items-center space-x-2">
                    <h2 className={`text-base sm:text-lg font-semibold ${getSectionColors('reservas').text}`}>üéØ Reservas</h2>
                    <button onClick={() => toggleSection('reservations')}>
                      {sectionVisibility.reservations ? '‚ñº' : '‚ñ∫'}
                    </button>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${darkMode ? 'bg-blue-800 text-blue-100' : 'bg-blue-100 text-blue-800'}`}>
                    {currencyFormat(reservations.reduce((sum, r) => sum + Number(r.amount || 0), 0))}
                  </span>
                </div>
                {sectionVisibility.reservations && (
                  <>
                    <div className="space-y-3">
                      {reservations.map(r => (
                        <div key={r.id} className={`flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded border ${darkMode ? 'border-blue-700' : 'border-blue-200'} mobile-space-y-2`}>
                          <div>
                            <div className="font-medium text-sm-responsive">{r.name}</div>
                            <div className="text-xs sm:text-sm opacity-70">{formatDateDisplay(r.date)}</div>
                          </div>
                          <div className="flex items-center space-x-2 w-full sm:w-auto justify-between sm:justify-start">
                            <span className="text-blue-500 text-sm-responsive">{currencyFormat(r.amount)}</span>
                            <div className="flex space-x-2">
                              <button onClick={() => startEditReservation(r)} className="touch-target">‚úèÔ∏è</button>
                              <button onClick={() => deleteReservation(r)} className="touch-target">üóëÔ∏è</button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button onClick={() => { setShowAddReservation(true); setEditingReservation(null); setFormReservation({ name:'', amount:'', date:'', notes:'' }); }} className={`mt-3 w-full py-2 rounded-lg border-2 border-dashed flex justify-center space-x-2 ${darkMode ? 'border-blue-600 hover:bg-blue-900/20' : 'border-blue-300 hover:bg-blue-100'} touch-target`}>
                      <Plus /><span>Adicionar Reserva</span>
                    </button>
                  </>
                )}
              </div>
            </main>
          )}

          {/* Bot√£o flutuante para adicionar pagamento */}
          {!showCreditCards && (
            <div className="fixed bottom-6 right-6 z-10">
              <button 
                onClick={() => { 
                  setShowAddPayment(true); 
                  setEditingPayment(null); 
                  setFormPayment({ title:'', amount:'', day:'', type:'variable', notes:'', category:'outros', paid: false, calculatedResult: '' }); 
                }} 
                className={`p-4 rounded-full shadow-lg text-white ${darkMode ? 'bg-blue-600' : 'bg-blue-500'} touch-target`}
              >
                <Plus />
              </button>
            </div>
          )}

          {/* Modal de senha */}
          {showPasswordModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-sm p-6 rounded-lg shadow-xl modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{appPassword ? 'Alterar Senha' : 'Definir Senha'}</h2>
                <div className="space-y-4">
                  <input type="password" placeholder="Nova Senha" value={passwordForm.new} onChange={(e) => setPasswordForm(prev => ({ ...prev, new: e.target.value }))} className={`w-full px-3 py-3 rounded border text-base ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`} />
                  <input type="password" placeholder="Confirmar Senha" value={passwordForm.confirm} onChange={(e) => setPasswordForm(prev => ({ ...prev, confirm: e.target.value }))} className={`w-full px-3 py-3 rounded border text-base ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`} />
                  {appPassword && <p className="text-xs text-yellow-600">Deixe em branco para remover a senha.</p>}
                </div>
                <div className="flex space-x-3 mt-6">
                  <button onClick={handleSetPassword} className="flex-1 py-3 rounded-lg bg-blue-600 text-white touch-target">Salvar</button>
                  <button onClick={() => setShowPasswordModal(false)} className="flex-1 py-3 rounded-lg bg-gray-500 text-white touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal para adicionar/editar cart√£o de cr√©dito */}
          {showAddCreditCard && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg shadow-xl modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{editingCreditCard ? 'Editar Cart√£o' : 'Adicionar Cart√£o'}</h2>
                <div className="space-y-3">
                  <input type="text" placeholder="Nome do Cart√£o (Ex: Visa Nubank)" value={formCreditCard.name} onChange={e => setFormCreditCard({ ...formCreditCard, name: e.target.value })} className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`} />
                  <input type="number" placeholder="Dia de Vencimento da Fatura" value={formCreditCard.dueDay} onChange={e => setFormCreditCard({ ...formCreditCard, dueDay: e.target.value })} className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`} min="1" max="31" />
                  
                  <ColorPicker 
                    selectedColor={formCreditCard.color} 
                    onColorSelect={(color) => setFormCreditCard({ ...formCreditCard, color })}
                  />
                </div>
                <div className="mt-4 flex space-x-2">
                  <button onClick={editingCreditCard ? updateCreditCard : addCreditCard} className="flex-1 bg-purple-600 text-white py-3 rounded touch-target">Salvar</button>
                  <button onClick={() => { setShowAddCreditCard(false); setEditingCreditCard(null); setFormCreditCard({ name: '', dueDay: '', color: CARD_COLORS[0] }); }} className="flex-1 bg-gray-500 text-white py-3 rounded touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal para adicionar/editar compra parcelada */}
          {showAddCreditPurchase && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg shadow-xl modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">
                  {editingCreditPurchase ? 'Editar Compra Parcelada' : 'Adicionar Compra Parcelada'}
                </h2>
                <div className="space-y-3">
                  <input 
                    type="text" 
                    placeholder="Descri√ß√£o da Compra" 
                    value={formCreditPurchase.title} 
                    onChange={e => setFormCreditPurchase({ ...formCreditPurchase, title: e.target.value })} 
                    className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`} 
                  />
                  <input 
                    type="text" 
                    placeholder="Valor Total da Compra" 
                    value={formCreditPurchase.totalAmount} 
                    onChange={e => setFormCreditPurchase({ ...formCreditPurchase, totalAmount: e.target.value })} 
                    className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`} 
                  />
                  <input 
                    type="number" 
                    placeholder="N√∫mero de Parcelas" 
                    value={formCreditPurchase.installmentCount} 
                    onChange={e => setFormCreditPurchase({ ...formCreditPurchase, installmentCount: e.target.value })} 
                    className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`} 
                    min="1" 
                  />
                  <select 
                    value={formCreditPurchase.cardId} 
                    onChange={e => setFormCreditPurchase({ ...formCreditPurchase, cardId: e.target.value })} 
                    className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                  >
                    <option value="">Selecione o Cart√£o</option>
                    {creditCards.map(card => (
                      <option key={card.id} value={card.id}>
                        {card.name} (Vence dia {card.dueDay})
                      </option>
                    ))}
                  </select>
                  <select 
                    value={formCreditPurchase.firstDueMonth} 
                    onChange={e => setFormCreditPurchase({ ...formCreditPurchase, firstDueMonth: e.target.value })} 
                    className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                  >
                    <option value={selectedMonthKey}>M√™s de In√≠cio (Fatura Atual)</option>
                  </select>
                </div>
                <div className="mt-4 flex space-x-2">
                  <button 
                    onClick={editingCreditPurchase ? updateCreditPurchase : addCreditPurchase} 
                    className="flex-1 bg-blue-600 text-white py-3 rounded touch-target"
                  >
                    {editingCreditPurchase ? 'Atualizar Compra' : 'Adicionar Compra'}
                  </button>
                  <button 
                    onClick={() => { 
                      setShowAddCreditPurchase(false); 
                      setEditingCreditPurchase(null);
                      setFormCreditPurchase({ title: '', totalAmount: '', installmentCount: '', firstDueMonth: selectedMonthKey, cardId: '', category: 'cartao' });
                    }} 
                    className="flex-1 bg-gray-500 text-white py-3 rounded touch-target"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal para adicionar/editar pagamento */}
          {showAddPayment && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{editingPayment ? 'Editar Pagamento' : 'Adicionar Pagamento'}</h2>
                <div className="space-y-3">
                  <input 
                    type="text" 
                    placeholder="Nome da conta" 
                    value={formPayment.title} 
                    onChange={e=>setFormPayment({...formPayment,title:e.target.value})} 
                    className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}
                  />
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Valor (R$)</label>
                    <input 
                      type="text" 
                      placeholder="Ex: 39,92 ou 20+19,92"
                      value={formPayment.amount} 
                      onChange={e=>{
                        const newValue = e.target.value;
                        const result = parseCurrencyInput(newValue);
                        setFormPayment(prev => ({ 
                          ...prev, 
                          amount: newValue,
                          calculatedResult: result !== '' ? result : ''
                        }));
                      }} 
                      className={`w-full p-3 border rounded text-base ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                    />
                    
                    {formPayment.calculatedResult !== '' && formPayment.calculatedResult !== undefined && 
                      !isNaN(Number(formPayment.calculatedResult)) && /[+\-*/]/.test(formPayment.amount) && (
                      <div className={`mt-2 p-2 rounded text-sm ${darkMode ? 'bg-gray-700 text-green-300' : 'bg-green-50 text-green-700'}`}>
                        <div className="flex justify-between items-center">
                          <span>Resultado do c√°lculo:</span>
                          <span className="font-bold">{currencyFormat(formPayment.calculatedResult)}</span>
                        </div>
                        <div className="text-xs mt-1 opacity-70">
                          {formPayment.amount} = {formatNumberForInput(formPayment.calculatedResult)}
                        </div>
                      </div>
                    )}
                    
                    <div className="text-xs mt-1 opacity-70">
                      Dica: Use +, -, *, / para c√°lculos (ex: 100+50, 200/2, 50*3)
                    </div>
                  </div>
                  
                  <input 
                    type="number" 
                    placeholder="Dia do vencimento" 
                    value={formPayment.day} 
                    onChange={e=>setFormPayment({...formPayment,day:e.target.value})} 
                    className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}
                  />
                  <select 
                    value={formPayment.category} 
                    onChange={e=>setFormPayment({...formPayment,category:e.target.value})} 
                    className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}
                  >
                    {CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                  
                  <div className="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label className="flex items-center">
                      <input 
                        type="radio" 
                        checked={formPayment.type==='variable'} 
                        onChange={()=>setFormPayment({...formPayment,type:'variable'})} 
                        className="mr-2"
                      /> 
                      Vari√°vel
                    </label>
                    <label className="flex items-center">
                      <input 
                        type="radio" 
                        checked={formPayment.type==='fixed'} 
                        onChange={()=>setFormPayment({...formPayment,type:'fixed'})} 
                        className="mr-2"
                      /> 
                      Fixa
                    </label>
                  </div>
                  
                  <div className="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label className="flex items-center">
                      <input 
                        type="radio" 
                        checked={!formPayment.paid} 
                        onChange={()=>setFormPayment({...formPayment,paid:false})} 
                        className="mr-2"
                      /> 
                      Pendente
                    </label>
                    <label className="flex items-center">
                      <input 
                        type="radio" 
                        checked={formPayment.paid} 
                        onChange={()=>setFormPayment({...formPayment,paid:true})} 
                        className="mr-2"
                      /> 
                      Pago
                    </label>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Observa√ß√µes (opcional)</label>
                    <textarea 
                      placeholder="Adicione observa√ß√µes sobre este pagamento..." 
                      value={formPayment.notes} 
                      onChange={e=>setFormPayment({...formPayment,notes:e.target.value})} 
                      rows="3"
                      className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}
                    />
                  </div>
                </div>
                <div className="mt-6 flex space-x-2">
                  <button onClick={editingPayment?updatePayment:addPayment} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors touch-target">
                    {editingPayment ? 'Atualizar' : 'Salvar'}
                  </button>
                  <button onClick={()=>{
                    setShowAddPayment(false);
                    setFormPayment({ title:'', amount:'', day:'', type:'variable', notes:'', category:'outros', paid: false, calculatedResult: '' });
                  }} className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium transition-colors touch-target">
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para adicionar/editar entrada */}
          {showAddEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{editingEntry?'Editar':'Adicionar'} Entrada</h2>
                <div className="space-y-3">
                  <input type="text" placeholder="Nome" value={formEntry.name} onChange={e=>setFormEntry({...formEntry,name:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="text" placeholder="Valor" value={formEntry.amount} onChange={e=>setFormEntry({...formEntry,amount:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="date" value={formEntry.date} onChange={e=>setFormEntry({...formEntry,date:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                </div>
                <div className="mt-4 flex space-x-2">
                  <button onClick={editingEntry?updateEntry:addEntry} className="flex-1 bg-green-600 text-white py-3 rounded touch-target">Salvar</button>
                  <button onClick={()=>setShowAddEntry(false)} className="flex-1 bg-gray-500 text-white py-3 rounded touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para adicionar/editar reserva */}
          {showAddReservation && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{editingReservation?'Editar':'Adicionar'} Reserva</h2>
                <div className="space-y-3">
                  <input type="text" placeholder="Nome" value={formReservation.name} onChange={e=>setFormReservation({...formReservation,name:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="text" placeholder="Valor" value={formReservation.amount} onChange={e=>setFormReservation({...formReservation,amount:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="date" value={formReservation.date} onChange={e=>setFormReservation({...formReservation,date:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                </div>
                <div className="mt-4 flex space-x-2">
                  <button onClick={editingReservation?updateReservation:addReservation} className="flex-1 bg-blue-600 text-white py-3 rounded touch-target">Salvar</button>
                  <button onClick={()=>setShowAddReservation(false)} className="flex-1 bg-gray-500 text-white py-3 rounded touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para adicionar/editar conta */}
          {showAddAccount && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">{editingAccount?'Editar':'Adicionar'} Conta</h2>
                <div className="space-y-3">
                  <input type="text" placeholder="Nome" value={formAccount.name} onChange={e=>setFormAccount({...formAccount,name:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="text" placeholder="Saldo M√™s Atual" value={formAccount.balance} onChange={e=>setFormAccount({...formAccount,balance:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                </div>
                <div className="mt-4 flex space-x-2">
                  <button onClick={editingAccount?updateAccount:addAccount} className="flex-1 bg-blue-600 text-white py-3 rounded touch-target">Salvar</button>
                  <button onClick={()=>setShowAddAccount(false)} className="flex-1 bg-gray-500 text-white py-3 rounded touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para adicionar parcelamento */}
          {showAddInstallment && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`w-full max-w-md p-6 rounded-lg modal-content ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                <h2 className="text-xl font-bold mb-4">Parcelamento</h2>
                <div className="space-y-3">
                  <input type="text" placeholder="Nome" value={formInstallment.title} onChange={e=>setFormInstallment({...formInstallment,title:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="text" placeholder="Valor Total" value={formInstallment.totalAmount} onChange={e=>setFormInstallment({...formInstallment,totalAmount:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="number" placeholder="Qtd Parcelas" value={formInstallment.installmentCount} onChange={e=>setFormInstallment({...formInstallment,installmentCount:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  <input type="number" placeholder="Dia Venc." value={formInstallment.firstDueDay} onChange={e=>setFormInstallment({...formInstallment,firstDueDay:e.target.value})} className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}/>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Observa√ß√µes (opcional)</label>
                    <textarea 
                      placeholder="Adicione observa√ß√µes sobre este parcelamento..." 
                      value={formInstallment.notes} 
                      onChange={e=>setFormInstallment({...formInstallment,notes:e.target.value})} 
                      rows="2"
                      className={`w-full p-3 border rounded text-base ${darkMode?'bg-gray-700 border-gray-600':''}`}
                    />
                  </div>
                </div>
                <div className="mt-4 flex space-x-2">
                  <button onClick={addInstallment} className="flex-1 bg-blue-600 text-white py-3 rounded touch-target">Salvar</button>
                  <button onClick={()=>setShowAddInstallment(false)} className="flex-1 bg-gray-500 text-white py-3 rounded touch-target">Cancelar</button>
                </div>
              </div>
            </div>
          )}

          {/* MODAIS PARA PDF */}
          {showPDFConfig && (
            <PDFConfigModal
              darkMode={darkMode}
              onClose={() => setShowPDFConfig(false)}
              onGenerate={handleGeneratePDF}
              defaultOptions={pdfOptions}
            />
          )}

          {showPDFPreview && pdfData && (
            <PDFPreviewModal
              data={pdfData}
              options={pdfOptions}
              darkMode={darkMode}
              onClose={() => setShowPDFPreview(false)}
              onGenerate={handleDownloadPDF}
            />
          )}

          {/* Notifica√ß√£o */}
          {notification.show && (
            <div className={`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`}>
              {notification.text}
            </div>
          )}
        </div>
      );
    }
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
